<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Grocery APP</title>
  <link rel="manifest" href="manifest.webmanifest">
  <style>
    html, body { overflow-x: hidden; margin:0; }
    * { box-sizing: border-box; }
    body { font-family: Arial, Helvetica, sans-serif; background:#f6f7fb; }
    header { padding:14px 16px; background:#111827; color:#fff; font-weight:700; font-size:18px; }
    .wrap { padding:14px 14px 90px; max-width:820px; margin:0 auto; }
    .row { display:flex; gap:10px; flex-wrap:wrap; }
    button {
      appearance:none; border:0; border-radius:14px; padding:14px 16px;
      font-size:16px; font-weight:800; cursor:pointer;
      background:#2563eb; color:#fff;
    }
    button.secondary { background:#e5e7eb; color:#111827; }
    button:disabled { opacity:.5; cursor:not-allowed; }
    .card {
      background:#fff; border-radius:16px; padding:12px; margin-top:12px;
      box-shadow: 0 6px 18px rgba(0,0,0,.08);
    }
    .item {
      display:flex; align-items:center; gap:10px;
      padding:10px 6px; border-bottom:1px solid #eee;
    }
    .item:last-child { border-bottom:0; }
    .check { width:26px; height:26px; }
    .name { flex:1; font-size:16px; cursor:pointer; }
    .done .name { text-decoration: line-through; opacity:.55; }
    .qty { width:64px; padding:8px 10px; border:1px solid #ddd; border-radius:12px; font-size:16px; }
    select { padding:8px 10px; border:1px solid #ddd; border-radius:12px; font-size:16px; background:#fff; }
    .price { width:96px; padding:8px 10px; border:1px solid #ddd; border-radius:12px; font-size:16px; }
    .total { font-weight:900; font-size:18px; }
    .delBtn {
      background:#fee2e2; color:#7f1d1d;
      padding:10px 12px; border-radius:12px; font-weight:900;
    }
    /* Scanner modal */
    .modalBg {
      position:fixed; inset:0; background:rgba(0,0,0,.55);
      display:none; align-items:center; justify-content:center; padding:16px;
      z-index: 9999;
    }
    .modal {
      width:min(760px, 100%);
      max-width: calc(100vw - 32px);
      background:#fff; border-radius:18px; overflow:hidden;
      box-shadow: 0 20px 60px rgba(0,0,0,.35);
      max-height: calc(100dvh - 32px);
      display:flex; flex-direction:column;
    }
    .modalHead {
      display:flex; justify-content:space-between; align-items:center;
      padding:12px 14px; background:#111827; color:#fff;
    }
    .modalBody {
      padding:12px; display:flex; flex-direction:column; gap:10px;
      overflow-y:auto; overscroll-behavior: contain;
      padding-bottom: env(safe-area-inset-bottom, 12px);
    }
    #reader {
      width:100%; max-height:45dvh; overflow:hidden; border-radius:16px;
    }
    #reader * { max-width:100% !important; box-sizing:border-box; }
    #reader video,
    #reader canvas {
      width:100% !important; height:auto !important;
      max-height:45dvh !important; object-fit:contain;
      border-radius:16px; display:block;
    }
    .hint { color:#6b7280; font-size:14px; margin-top:0; }
    .scanBar {
      margin-top:10px; background:rgba(17,24,39,.06);
      border:1px solid rgba(17,24,39,.10); border-radius:14px;
      padding:10px 12px; display:flex; align-items:center;
      justify-content:space-between; gap:10px; flex-wrap:wrap;
      position:sticky; bottom:0; z-index:5; background:#fff;
      box-shadow:0 -6px 18px rgba(0,0,0,.06);
    }
    .scanMsg {
      font-weight:900; font-size:16px; color:#111827;
      flex:1; min-width:0; overflow-wrap:anywhere;
    }
    .scanMsg.ok { color:#065f46; }
    .scanMsg.warn { color:#92400e; }
    .scanBtns { display:flex; gap:10px; flex-wrap:wrap; flex:0 0 auto; }
    .capBtn { background:#16a34a; }
    .doneBtn { background:#e5e7eb; color:#111827; }
  </style>
  <script src="https://unpkg.com/html5-qrcode"></script>
</head>
<body>
  <header>Grocery APP <span style="opacity:.7;font-weight:600;">(build 008)</span></header>
  <div class="wrap">
    <div class="row">
      <button id="btnNew">New List</button>
      <button id="btnScan">SCAN</button>
      <button id="btnUndo" class="secondary">Undo</button>
      <button id="btnClearDone" class="secondary">Clear Purchased</button>
      <button id="btnAdd" class="secondary">Add Item</button>
    </div>
    <div class="card">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;">
        <div><b>Current List:</b> <span id="listName">Today</span></div>
        <div class="total">Total: $<span id="total">0.00</span></div>
      </div>
    </div>
    <div class="card" id="listCard"></div>
  </div>

  <div class="modalBg" id="modalBg">
    <div class="modal">
      <div class="modalHead">
        <div><b>Scan Items</b></div>
        <button id="btnCloseTop" class="secondary" style="padding:10px 12px; border-radius:12px;">Close</button>
      </div>
      <div class="modalBody">
        <div id="reader"></div>
        <div class="scanBar">
          <div id="scanMsg" class="scanMsg">Point at QR and hold still‚Ä¶</div>
          <div class="scanBtns">
            <button id="btnCapture" class="capBtn" disabled>CAPTURE</button>
            <button id="btnDone" class="doneBtn">DONE</button>
          </div>
        </div>
        <div class="hint">
          Tip: good lighting + steady hands = faster scans
        </div>
      </div>
    </div>
  </div>

  <script>
  if ("serviceWorker" in navigator) navigator.serviceWorker.register("sw.js").catch(console.warn);

  const LS_KEY = "groceryApp_v1";
  const UNITS = ["ea","lb","oz","gal","ct"];

  function loadState() {
    try { return JSON.parse(localStorage.getItem(LS_KEY)) || null; }
    catch { return null; }
  }

  function saveState(s) { localStorage.setItem(LS_KEY, JSON.stringify(s)); }

  function newBlankList(name) { return { name, items: [], created: Date.now() }; }

  let state = loadState() || { current: newBlankList("Today") };
  let lastAddedId = null;
  let renderTimeout = null;

  function money(n) { return (Math.round((n||0)*100)/100).toFixed(2); }

  function computeTotal() {
    return state.current.items.reduce((sum, it) => {
      const p = parseFloat(it.price) || 0;
      const q = parseFloat(it.qty) || 1;
      return sum + p * q;
    }, 0);
  }

  function generateId() {
    if (crypto.randomUUID) return crypto.randomUUID();
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
      const r = Math.random() * 16 | 0;
      return (c === 'x' ? r : (r & 0x3 | 0x8)).toString(16);
    });
  }

  function addItem(name) {
    name = String(name ?? "").trim();
    if (!name) return;

    const item = {
      id: generateId(),
      name,
      done: false,
      qty: "1",
      unit: "ea",
      price: ""
    };
    state.current.items.push(item);
    lastAddedId = item.id;
    saveState(state);
    debouncedRender();
  }

  function deleteItemById(id) {
    const idx = state.current.items.findIndex(x => x.id === id);
    if (idx === -1) return;
    state.current.items.splice(idx, 1);
    if (lastAddedId === id) lastAddedId = null;
    saveState(state);
    debouncedRender();
  }

  function updateItem(id, changes) {
    const item = state.current.items.find(x => x.id === id);
    if (!item) return;
    Object.assign(item, changes);
    saveState(state);
    debouncedRender();
  }

  function debouncedRender() {
    clearTimeout(renderTimeout);
    renderTimeout = setTimeout(render, 80);
  }

  function escapeHtml(s) {
    return String(s ?? "").replace(/[&<>"']/g, m => ({
      "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#039;"
    }[m]));
  }

  function render() {
    document.getElementById("listName").textContent = state.current.name;
    document.getElementById("total").textContent = money(computeTotal());

    const card = document.getElementById("listCard");
    if (state.current.items.length === 0) {
      card.innerHTML = `<div style="padding:16px; color:#6b7280; text-align:center;">
        No items yet.<br>Tap <b>SCAN</b> or <b>Add Item</b>.
      </div>`;
      return;
    }

    card.innerHTML = state.current.items.map(it => `
      <div class="item ${it.done ? "done":""}" data-id="${it.id}">
        <input class="check" type="checkbox" ${it.done ? "checked":""}>
        <div class="name">${escapeHtml(it.name)}</div>
        <input class="qty" type="number" step="0.5" min="0" value="${it.qty}">
        <select class="unit">
          ${UNITS.map(u => `<option ${u===it.unit?"selected":""}>${u}</option>`).join("")}
        </select>
        <input class="price" type="number" step="0.01" min="0" placeholder="$" value="${escapeHtml(it.price)}">
        <button class="delBtn" title="Delete">üóëÔ∏è</button>
      </div>
    `).join("");

    card.querySelectorAll(".item").forEach(row => {
      const id = row.dataset.id;
      const item = state.current.items.find(x => x.id === id);
      if (!item) return;

      row.querySelector(".check").onchange = e => {
        updateItem(id, { done: e.target.checked });
      };

      row.querySelector(".qty").onchange = e => {
        let v = parseFloat(e.target.value) || 0;
        v = Math.max(0, Math.min(999, v));
        updateItem(id, { qty: String(v) });
      };

      row.querySelector(".unit").onchange = e => {
        updateItem(id, { unit: e.target.value });
      };

      row.querySelector(".price").onchange = e => {
        let v = parseFloat(e.target.value);
        updateItem(id, { price: isNaN(v) ? "" : String(Math.max(0, v)) });
      };

      row.querySelector(".delBtn").onclick = () => deleteItemById(id);

      // Tap name ‚Üí edit
      row.querySelector(".name").onclick = () => {
        const newName = prompt("Edit item:", item.name);
        if (newName && newName.trim() !== item.name) {
          updateItem(id, { name: newName.trim() });
        }
      };
    });
  }

  // ‚îÄ‚îÄ UI actions ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  document.getElementById("btnNew").onclick = () => {
    const name = prompt("List name?", state.current.name);
    if (!name?.trim()) return;
    state.current = newBlankList(name.trim());
    lastAddedId = null;
    saveState(state);
    render();
  };

  document.getElementById("btnAdd").onclick = () => {
    const name = prompt("Add item:");
    if (name) addItem(name.trim());
  };

  document.getElementById("btnUndo").onclick = () => {
    if (lastAddedId) deleteItemById(lastAddedId);
  };

  document.getElementById("btnClearDone").onclick = () => {
    const before = state.current.items.length;
    state.current.items = state.current.items.filter(x => !x.done);
    if (state.current.items.length !== before) {
      saveState(state);
      render();
    }
  };

  // ‚îÄ‚îÄ Scanner logic ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const modalBg = document.getElementById("modalBg");
  const scanMsgEl = document.getElementById("scanMsg");
  let qr = null;
  let pendingLabel = "";
  let targetLocked = false;
  let audioCtx = null;

  function beep() {
    try {
      if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.type = "sine"; osc.frequency.value = 880;
      gain.gain.value = 0.06;
      osc.connect(gain); gain.connect(audioCtx.destination);
      osc.start();
      setTimeout(() => osc.stop(), 90);
    } catch {}
  }

  function setScanMsg(text, cls = "") {
    scanMsgEl.textContent = text;
    scanMsgEl.className = "scanMsg" + (cls ? ` ${cls}` : "");
  }

  function resetTarget() {
    pendingLabel = "";
    targetLocked = false;
    document.getElementById("btnCapture").disabled = true;
    setScanMsg("Point at QR and hold still‚Ä¶");
  }

  function parseLabel(text) {
    if (typeof text !== "string" || text.length > 2000) return "Invalid";
    text = text.trim().slice(0, 120);
    try {
      const url = new URL(text);
      const item = url.searchParams.get("item");
      if (item) return decodeURIComponent(item).trim().slice(0, 100);
      const dish = url.searchParams.get("dish");
      if (dish) return "DISH: " + decodeURIComponent(dish).trim().slice(0, 80);
      return text;
    } catch {
      return text;
    }
  }

  async function openScanner() {
    modalBg.style.display = "flex";
    resetTarget();
    document.getElementById("reader").innerHTML = "";

    qr = new Html5Qrcode("reader", { formatsToSupport: [Html5QrcodeSupportedFormats.QR_CODE] });

    try {
      const cameras = await Html5Qrcode.getCameras();
      if (!cameras?.length) throw new Error("No cameras found");

      const rear = cameras.find(c => /back|rear|environment/i.test(c.label)) || cameras[cameras.length-1];

      const qrboxFunction = (vw, vh) => {
        const min = Math.min(vw, vh);
        const size = Math.round(min * 0.70);
        return { width: size, height: size };
      };

      await qr.start(
        rear.id,
        { fps: 12, qrbox: qrboxFunction },
        onScanSuccess
      );
    } catch (err) {
      setScanMsg("Scanner error. Try again or close.", "warn");
      console.warn(err);
      setTimeout(closeScanner, 1800);
    }
  }

  async function closeScanner() {
    modalBg.style.display = "none";
    resetTarget();

    if (!qr) return;

    try {
      await qr.stop();
      qr.clear();
    } catch (err) {
      console.warn("Scanner cleanup failed", err);
    } finally {
      qr = null;
      document.getElementById("reader").innerHTML = "";
    }
  }

  function onScanSuccess(decodedText) {
    if (targetLocked) return;
    targetLocked = true;
    pendingLabel = parseLabel(decodedText);

    if (navigator.vibrate) navigator.vibrate([40,40,40]);
    beep();

    document.getElementById("btnCapture").disabled = false;
    setScanMsg(`Target acquired: ${pendingLabel}`, "ok");
  }

  document.getElementById("btnCapture").onclick = () => {
    if (!pendingLabel) return;
    addItem(pendingLabel);
    setScanMsg(`‚úÖ Added: ${pendingLabel}`, "ok");
    document.getElementById("btnCapture").disabled = true;
    setTimeout(resetTarget, 800);
  };

  document.getElementById("btnScan").onclick = openScanner;
  document.getElementById("btnCloseTop").onclick = closeScanner;
  document.getElementById("btnDone").onclick = closeScanner;
  modalBg.onclick = e => { if (e.target === modalBg) closeScanner(); };

  // Initial render
  render();
  </script>
</body>
</html>
