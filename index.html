<!-- ============================================================
  VERSIONING REMINDER (READ BEFORE CHANGING CODE)
  ------------------------------------------------------------
  When making ANY functional change:

  1) Update APP_VERSION below
     - Controls localStorage key (groceryApp_v##)
     - Prevents data/version confusion

  2) Update the visible build label in the header (optional but recommended)
     - Helps humans confirm the correct build is loaded

  3) Update VERSION in sw.js
     - Forces Service Worker + cache refresh

  4) Commit ALL related files together

  If you forget step #3, the browser may keep serving old code.
============================================================ -->

<!-- =========================
     index.html  (BUILD 067)
     ========================= -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Grocery APP</title>
  <link rel="manifest" href="manifest.webmanifest">

  <style>
    html, body { overflow-x: hidden; margin:0; }
    * { box-sizing: border-box; }

    :root{
      /* Core palette (warmer + friendlier) */
      --navy:#0b1220;

      /* ‚ÄúApp language‚Äù colors */
      --primary:#2563eb;
      --primary2:#1d4ed8;
      --success:#16a34a;
      --success2:#15803d;
      --scan:#f59e0b;
      --scan2:#d97706;
      --danger:#ef4444;
      --danger2:#dc2626;

      /* Softer neutrals */
      --card:#ffffff;
      --ink:#0f172a;
      --muted:#64748b;
      --soft:#f3f1ff;
      --soft2:#eef2ff;

      --border:rgba(15,23,42,.10);
      --shadow: 0 10px 26px rgba(2,6,23,.10);
      --shadow2: 0 14px 34px rgba(2,6,23,.12);

      --r-lg: 22px;
      --r-md: 18px;
      --r-pill: 999px;
    }

    body{
      font-family: Arial, Helvetica, sans-serif;
      background: linear-gradient(180deg, #fbfbff 0%, #f3f1ff 45%, #eef2ff 100%);
      color: var(--ink);
    }

    header{
      padding:14px 16px;
      background: linear-gradient(90deg, #0b1220 0%, #111827 55%, #0b1220 100%);
      color:#fff;
      font-weight:800;
      font-size:18px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      letter-spacing: .3px;
    }

    .wrap { padding:16px 14px 90px; max-width:820px; margin:0 auto; }

    /* Tabs row */
    .tabs{
      display:flex;
      gap:12px;
      margin-bottom:14px;
      align-items:center;
      flex-wrap:wrap;
    }

    .tabBtn{
      background: linear-gradient(180deg, #f4f2ff 0%, #ecebff 100%);
      color: var(--ink);
      border-radius: var(--r-pill);
      padding: 12px 20px;
      font-weight: 900;
      border: 1px solid rgba(15,23,42,.12);
      box-shadow: none;
      cursor:pointer;
    }

    .tabBtn.active{
      background: linear-gradient(180deg, #111827 0%, #0b1220 100%);
      color:#fff;
      border: 0;
      box-shadow: 0 12px 22px rgba(2,6,23,.18);
    }

    /* Push right-side buttons to the edge */
    #btnClearDone{ margin-left:auto; }
    #btnMore{
      padding: 10px 14px;
      border-radius: var(--r-pill);
      font-weight: 900;
      line-height: 1;
      min-width: 48px;
    }

    /* Base row */
    .row { display:flex; gap:12px; flex-wrap:wrap; }

    /* ACTION row (Groceries main buttons) should fill width */
    .actionRow{
      justify-content: space-between;
    }
    .actionRow button{
      flex: 1 1 150px;  /* grows to fill, wraps nicely */
      min-width: 140px;
    }

    button{
      appearance:none;
      border:0;
      border-radius: var(--r-md);
      padding: 14px 18px;
      font-size: 16px;
      font-weight: 900;
      cursor: pointer;
      color:#fff;
      background: linear-gradient(180deg, var(--primary) 0%, var(--primary2) 100%);
      box-shadow: var(--shadow);
      transition: transform .08s ease, filter .12s ease, box-shadow .12s ease;
      letter-spacing: .2px;
    }

    /* ===== SHOP dropdown (add BELOW button{}) ===== */
    .shopWrap{
      position: relative;
      display: inline-block;
      margin-left: 20px;   /* space between UNDO and SHOP */
    }

    .shopMenu{
      position: absolute;
      top: calc(100% + 8px);
      right: 0;
      min-width: 180px;
      padding: 8px;
      background: #fff;
      border: 1px solid rgba(0,0,0,.2);
      border-radius: 10px;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
      z-index: 9999;
    }

    .shopMenu.hidden{ display: none; }

    .shopItem{
      width: 100%;
      padding: 10px 12px;
      text-align: left;
      border: 0;
      background: transparent;
      cursor: pointer;
      color: #000;           /* ‚úÖ FIX: always visible text */
    }

    .shopItem:hover{ background: rgba(0,0,0,.08); }

    button:active{ transform: translateY(1px); }
    button:hover{ filter: brightness(1.03); box-shadow: var(--shadow2); }
    button:disabled{ opacity:.55; cursor:not-allowed; box-shadow:none; filter:none; }

    button.secondary{
      background: linear-gradient(180deg, #f4f2ff 0%, #ecebff 100%);
      color: var(--ink);
      border: 1px solid rgba(15,23,42,.12);
      box-shadow: 0 10px 18px rgba(2,6,23,.06);
    }

    button.danger{
      background: linear-gradient(180deg, var(--danger) 0%, var(--danger2) 100%);
      color:#fff;
      box-shadow: 0 12px 22px rgba(239,68,68,.16);
    }

    /* Intent colors */
    button.scanQR{
      background: linear-gradient(180deg, #3b82f6 0%, #2563eb 100%);
    }
    button.scanUPC{
      background: linear-gradient(180deg, var(--scan) 0%, var(--scan2) 100%);
      box-shadow: 0 10px 18px rgba(245,158,11,.22);
    }

    #btnUndo{
      min-width: 60px !important;
      padding-left: 6px;
      padding-right: 6px;
      background: linear-gradient(180deg, #a78bfa 0%, #7c3aed 100%) !important;
      color:#fff !important;
      border:0 !important;
      box-shadow: 0 12px 22px rgba(124,58,237,.18) !important;
    }

    #btnAdd{
      background: linear-gradient(180deg, #22c55e 0%, #16a34a 100%) !important;
      color:#fff !important;
      border:0 !important;
      box-shadow: 0 12px 22px rgba(34,197,94,.18) !important;
    }
    #btnMasterAddSelected{
      background: linear-gradient(180deg, #14b8a6 0%, #0d9488 100%) !important;
      color:#fff !important;
      border:0 !important;
      box-shadow: 0 12px 22px rgba(20,184,166,.18) !important;
    }

    .card{
      background: var(--card);
      border-radius: var(--r-lg);
      padding:12px;
      margin-top:12px;
      border: 1px solid rgba(15,23,42,.08);
      box-shadow: 0 16px 34px rgba(2,6,23,.10);
    }

    .muted { color: var(--muted); }
    .spacer { height:10px; }
    .total { font-weight:900; font-size:18px; letter-spacing:.2px; }

    /* Rows / pills */
    .pill,
    .catPill{
      font-size:12px; font-weight:900;
      padding:6px 10px; border-radius:999px;
      background:#e5e7eb; color:#111827;
      white-space:nowrap;
      border: 1px solid rgba(15,23,42,.10);
    }
    .pill.ok{ background:rgba(34,197,94,.18); color:#065f46; }
    .pill.warn{ background:rgba(245,158,11,.18); color:#92400e; }

    /* Grocery list rows */
    .item {
      display:flex; align-items:center; gap:10px;
      padding:10px 6px; border-bottom:1px solid #eee;
    }
    .item:last-child { border-bottom:0; }
    .check { width:26px; height:26px; }
    .name { flex:1; font-size:16px; cursor:pointer; }
    .done .name { text-decoration: line-through; opacity:.55; }
    .qty { width:64px; padding:8px 10px; border:1px solid #ddd; border-radius:12px; font-size:16px; }
    select { padding:8px 10px; border:1px solid #ddd; border-radius:12px; font-size:16px; background:#fff; }
    .price { width:96px; padding:8px 10px; border:1px solid #ddd; border-radius:12px; font-size:16px; }

    /* Master list rows */
    .masterRow{
      display:flex; align-items:center; gap:10px;
      padding:10px 6px; border-bottom:1px solid #eee;
    }
    .masterRow:last-child{ border-bottom:0; }
    .mName{ flex:1; font-size:16px; cursor:pointer; font-weight:800; }
    .mCheck{ width:26px; height:26px; }

    /* Dish rows */
    .dishRow{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:10px 6px; border-bottom:1px solid #eee;
    }
    .dishRow:last-child{ border-bottom:0; }
    .dishName{ font-size:16px; font-weight:800; cursor:pointer; }

    /* Row delete buttons: soft danger */
    .delBtn{
      background: rgba(239,68,68,.10);
      color:#7f1d1d;
      padding:10px 12px;
      border-radius: 14px;
      font-weight: 900;
      box-shadow:none;
      border: 1px solid rgba(239,68,68,.18);
    }
    .delBtn:hover{ filter: brightness(1.02); }

    /* Scanner modal */
    .modalBg {
      position:fixed; inset:0; background:rgba(0,0,0,.55);
      display:none; align-items:center; justify-content:center; padding:16px;
      z-index: 9999;
    }
    .modal {
      width:min(760px, 100%);
      max-width: calc(100vw - 32px);
      background:#fff; border-radius:18px; overflow:hidden;
      box-shadow: 0 20px 60px rgba(0,0,0,.35);
      max-height: calc(100dvh - 32px);
      display:flex; flex-direction:column;
    }
    .modalHead {
      display:flex; justify-content:space-between; align-items:center;
      padding:12px 14px; background:#111827; color:#fff;
    }
    .modalBody {
      padding:12px; display:flex; flex-direction:column; gap:10px;
      overflow-y:auto; overscroll-behavior: contain;
      padding-bottom: env(safe-area-inset-bottom, 12px);
    }
    #reader {
      width:100%; max-height:50dvh; overflow:hidden; border-radius:16px; background:#000;
    }
    #reader * { max-width:100% !important; box-sizing:border-box; }
    #reader video,
    #reader canvas {
      width:100% !important; height:auto !important;
      max-height:50dvh !important; object-fit:contain;
      border-radius:16px; display:block;
    }
    .hint { color:#6b7280; font-size:14px; margin-top:0; }
    .scanBar {
      margin-top:10px; background:rgba(17,24,39,.06);
      border:1px solid rgba(17,24,39,.10); border-radius:14px;
      padding:10px 12px; display:flex; align-items:center;
      justify-content:space-between; gap:10px; flex-wrap:wrap;
      position:sticky; bottom:0; z-index:5; background:#fff;
      box-shadow:0 -6px 18px rgba(0,0,0,.06);
    }
    .scanMsg {
      font-weight:900; font-size:16px; color:#111827;
      flex:1; min-width:0; overflow-wrap:anywhere;
    }
    .scanMsg.ok { color:#065f46; }
    .scanMsg.warn { color:#92400e; }
    .scanBtns { display:flex; gap:10px; flex-wrap:wrap; flex:0 0 auto; }
    .capBtn { background:#16a34a; }
    .doneBtn { background:#e5e7eb; color:#111827; }

    /* Add/Edit modal */
    .miniBg{
      position:fixed; inset:0; background:rgba(0,0,0,.55);
      display:none; align-items:center; justify-content:center; padding:16px;
      z-index: 9998;
    }

    /* PHASE 2: Ingredient rows inside Dish modal */
    .ingRow{
      display:flex;
      gap:10px;
      align-items:center;
    }
    .ingRow input{
      flex:1;
      padding:12px 12px;
      border:1px solid #ddd;
      border-radius:14px;
      font-size:16px;
    }
    .ingRow select{
      width:160px;
      padding:12px 12px;
      border:1px solid #ddd;
      border-radius:14px;
      font-size:16px;
      background:#fff;
    }
    .ingRow .delBtn{ padding:10px 12px; }

    .mini{
      width:min(520px, 100%);
      background:#fff; border-radius:18px; overflow:hidden;
      box-shadow:0 20px 60px rgba(0,0,0,.35);
    }
    .miniHead{
      padding:12px 14px; background:#111827; color:#fff;
      display:flex; justify-content:space-between; align-items:center;
      font-weight:900;
    }
    .miniBody{ padding:12px 14px; display:flex; flex-direction:column; gap:10px; }
    .miniRow{ display:flex; flex-direction:column; gap:6px; }
    .miniRow label{ font-weight:900; color:#111827; }
    .miniRow input, .miniRow select{
      width:100%; padding:12px 12px; border:1px solid #ddd;
      border-radius:14px; font-size:16px;
    }
    .miniBtns{ display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; padding:0 14px 14px; }

    /* Tools screen */
    .toolRow{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
    }
    .toolRow button{ flex: 1 1 220px; min-width: 200px; }
    .smallNote{ font-size: 13px; color: var(--muted); line-height: 1.35; }
    .reportBox{
      white-space: pre-wrap;
      background: rgba(17,24,39,.04);
      border: 1px solid rgba(17,24,39,.10);
      border-radius: 14px;
      padding: 10px 12px;
      font-size: 13px;
      color: #111827;
    }
    .toggleRow{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
      padding: 10px 12px;
      border: 1px solid rgba(15,23,42,.10);
      border-radius: 14px;
      background: rgba(255,255,255,.7);
    }
    .toggleRow label{
      display:flex; align-items:center; gap:10px;
      font-weight: 900;
    }
    .toggleRow input[type="checkbox"]{ width: 22px; height: 22px; }

    /* ===== Category Manager ===== */
    .catRow{
      display:flex; align-items:center; gap:10px;
      padding:10px 8px;
      border:1px solid rgba(15,23,42,.10);
      border-radius:14px;
      background: rgba(17,24,39,.03);
      margin-bottom:10px;
    }
    .catRow.dragging{ opacity:.6; }
    .catHandle{
      width:38px; text-align:center;
      border-radius:12px;
      background: rgba(17,24,39,.08);
      border:1px solid rgba(17,24,39,.10);
      padding:10px 0;
      cursor: grab;
      user-select:none;
      font-weight: 900;
    }
    .catLabel{
      flex:1; font-weight: 900;
      padding:10px 12px;
      border-radius: 12px;
      border:1px solid rgba(15,23,42,.10);
      background:#fff;
    }
    .catTinyBtn{
      padding:10px 12px;
      border-radius: 14px;
      font-weight: 900;
      background: rgba(37,99,235,.12);
      color:#1d4ed8;
      border:1px solid rgba(37,99,235,.18);
      box-shadow:none;
    }
    .catTinyBtn:hover{ filter: brightness(1.02); }
    .catTinyBtn.dangerTiny{
      background: rgba(239,68,68,.10);
      color:#7f1d1d;
      border:1px solid rgba(239,68,68,.18);
    }
  </style>

  <script src="https://unpkg.com/html5-qrcode"></script>
</head>

<body>
  <header>Grocery APP <span style="opacity:.7;font-weight:600;">(Build 067)</span></header>

  <div class="wrap">
    <div class="tabs">
      <button id="tabGroceries" class="tabBtn active">Groceries</button>
      <button id="tabDishes" class="tabBtn">Dishes</button>

      <!-- ‚ãØ More button (Groceries -> Tools) -->
      <button id="btnMore" class="secondary" title="More / Import / Export">‚ãØ</button>

      <button id="btnClearDone" class="secondary">Clear Purchased</button>
    </div>

    <!-- GROCERIES TAB -->
    <div id="screenGroceries">
      <div class="row actionRow">
        <button id="btnNew">New List</button>
        <button id="btnScan" class="scanQR">SCAN QR</button>
        <button id="btnScanUPC" class="scanUPC">SCAN UPC</button>
        <button id="btnAdd" class="secondary">Add Item</button>
        <button id="btnUndo" class="secondary">Undo</button>

        <!-- SHOP button + dropdown -->
        <div class="shopWrap">
          <button id="btnShop" class="secondary">SHOP</button>
          <div id="shopMenu" class="shopMenu hidden" role="menu" aria-label="Shop links">
            <button class="shopItem" data-url="https://www.walmart.com/" role="menuitem">Walmart</button>
            <button class="shopItem" data-url="https://www.publix.com/" role="menuitem">Publix</button>
            <button class="shopItem" data-url="https://www.kroger.com/" role="menuitem">Kroger</button>
            <button class="shopItem" data-url="https://www.ingles-markets.com/" role="menuitem">Ingles</button>
          </div>
        </div>
      </div>

      <!-- Shopping list summary -->
      <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;">
          <div>
            <b>Shopping List:</b> <span id="listName">Today</span><br>
            <span class="muted">Sorted by category walking order + name.</span>
          </div>
          <div class="total">Total: $<span id="total">0.00</span></div>
        </div>
      </div>

      <!-- Shopping list card FIRST (above Master) -->
      <div class="card" id="listCard"></div>

      <!-- Master list AFTER shopping list -->
      <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;">
          <div>
            <b>Master Grocery List:</b>
            <span class="pill"><span id="masterCount">0</span> items</span>
          </div>
          <div class="muted">Check items here, then tap <b>ADD SELECTED</b>.</div>
        </div>

        <div class="spacer"></div>

        <div class="row">
          <button id="btnMasterAddSelected" class="secondary">ADD SELECTED</button>
          <button id="btnMasterClearChecks" class="secondary">CLEAR CHECKS</button>
          <button id="btnMasterClear" class="danger">Clear Master</button>
        </div>

        <div class="spacer"></div>
        <div id="masterCard"></div>
      </div>
    </div>

    <!-- DISHES TAB -->
    <div id="screenDishes" style="display:none;">
      <div class="row">
        <button id="btnScanDish">SCAN DISH</button>
        <button id="btnAddDish" class="secondary">Add Dish</button>
        <button id="btnRandom14" class="secondary">Random Menu (14)</button>
        <button id="btnAddCheckedIng" class="secondary">Add ING. To Shopping List</button>
        <button id="btnClearMenu" class="secondary">Clear Menu</button>
      </div>

      <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;">
          <div><b>Current Menu:</b> <span class="pill ok"><span id="menuCount">0</span> dishes</span></div>
          <div class="muted">Scanning a dish adds it to Menu + Catalog.</div>
        </div>
      </div>
      <div class="card" id="menuCard"></div>

      <!-- Dish Catalog card with Clear Catalog inside it -->
      <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;">
          <div><b>Dish Catalog:</b> <span class="pill"><span id="catalogCount">0</span> total</span></div>

          <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end;">
            <div class="muted">Tap a dish to rename; delete button removes menu/catalog.</div>
            <button id="btnClearCatalog" class="danger">Clear Catalog</button>
          </div>
        </div>

        <div class="spacer"></div>
        <div id="catalogCard"></div>
      </div>
    </div>

    <!-- TOOLS / IMPORT EXPORT SCREEN -->
    <div id="screenTools" style="display:none;">
      <div class="row">
        <button id="btnToolsBack" class="secondary">‚Üê Back</button>
      </div>

      <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;">
          <div><b>More / Tools</b></div>
          <div class="muted">Export/Import for multi-device manual sync.</div>
        </div>

        <div class="spacer"></div>

        <div class="miniRow">
          <label for="deviceName">Device name (included in export file)</label>
          <input id="deviceName" type="text" placeholder="e.g., Dave-iPhone, Kitchen-iPad, Laptop" />
          <div class="smallNote">Tip: Use a unique name per device so you can tell exports apart.</div>
        </div>
      </div>

      <!-- NEW: Category Manager entry -->
      <div class="card">
        <b>Categories</b>
        <div class="spacer"></div>
        <div class="toolRow">
          <button id="btnManageCats" class="secondary">Manage Categories (add / rename / reorder / delete)</button>
        </div>
        <div class="spacer"></div>
        <div class="smallNote">
          Categories are stored locally on this device. Default categories come from the code; your additions/ordering are saved in localStorage.
        </div>
      </div>

      <div class="card">
        <b>Export</b>
        <div class="spacer"></div>
        <div class="toolRow">
          <button id="btnExportAll" class="secondary">Export ALL (recommended)</button>
          <button id="btnExportMaster" class="secondary">Export Master Groceries</button>
          <button id="btnExportDishes" class="secondary">Export Dish Catalog</button>
          <button id="btnExportUPC" class="secondary">Export UPC DB</button>
        </div>
        <div class="spacer"></div>
        <div class="smallNote">
          Export creates a JSON file you can AirDrop/email/text to your other device, then import there.
        </div>
      </div>

      <div class="card">
        <b>Import (MERGE)</b>
        <div class="spacer"></div>

        <div class="toggleRow">
          <label><input id="impOverwriteUPC" type="checkbox"> Overwrite UPC conflicts (default: skip conflicts)</label>
        </div>

        <div class="spacer"></div>

        <div class="toolRow">
          <button id="btnImport" class="secondary">Import JSON (merge)</button>
        </div>

        <input id="importFile" type="file" accept=".json,application/json" style="display:none;" />

        <div class="spacer"></div>
        <div class="reportBox" id="importReport">No import yet.</div>
      </div>
    </div>
  </div>

  <!-- Scanner Modal -->
  <div class="modalBg" id="modalBg">
    <div class="modal">
      <div class="modalHead">
        <div><b id="scanTitle">Scan</b></div>
        <button id="btnCloseTop" class="secondary" style="padding:10px 12px; border-radius:12px;">Close</button>
      </div>
      <div class="modalBody">
        <div id="reader"></div>
        <div class="scanBar">
          <div id="scanMsg" class="scanMsg">Point camera at code ‚Äì hold steady‚Ä¶</div>
          <div class="scanBtns">
            <button id="btnCapture" class="capBtn" disabled>CAPTURE</button>
            <button id="btnDone" class="doneBtn">DONE</button>
          </div>
        </div>
        <div class="hint" id="scanHint">
          Tip: Fill the capture box with the code and hold steady.
        </div>
      </div>
    </div>
  </div>

  <!-- Add/Edit Item Modal -->
  <div class="miniBg" id="miniBg">
    <div class="mini">
      <div class="miniHead">
        <div id="miniTitle">Add Item</div>
        <button id="miniClose" class="secondary" style="padding:10px 12px; border-radius:12px;">X</button>
      </div>
      <div class="miniBody">
        <div class="miniRow">
          <label for="miniName">Item name</label>
          <input id="miniName" type="text" placeholder="e.g., Milk" />
        </div>
        <div class="miniRow">
          <label for="miniCat">Category</label>
          <select id="miniCat"></select>
        </div>
      </div>
      <div class="miniBtns">
        <button id="miniCancel" class="secondary">Cancel</button>
        <button id="miniOk">OK</button>
      </div>
    </div>
  </div>

  <!-- Dish Ingredients Modal (PHASE 2) -->
  <div class="miniBg" id="dishBg" style="display:none;">
    <div class="mini">
      <div class="miniHead">
        <div id="dishTitle">Dish Ingredients</div>
        <button id="dishClose" class="secondary" style="padding:10px 12px; border-radius:12px;">X</button>
      </div>

      <div class="miniBody" style="gap:12px;">
        <div class="muted" style="font-size:14px;">
          Add ingredients for this dish. These will be used when you ‚ÄúAdd ING. To Shopping List‚Äù.
        </div>

        <div id="dishIngList" style="display:flex; flex-direction:column; gap:10px;"></div>

        <button id="dishAddIng" class="secondary" type="button">+ Add Ingredient</button>
      </div>

      <div class="miniBtns">
        <button id="dishCancel" class="secondary" type="button">Cancel</button>
        <button id="dishSave" type="button">Save</button>
      </div>
    </div>
  </div>

  <!-- Category Manager Modal -->
  <div class="miniBg" id="catBg" style="display:none;">
    <div class="mini" style="width:min(760px, 100%);">
      <div class="miniHead">
        <div id="catTitle">Manage Categories</div>
        <button id="catClose" class="secondary" style="padding:10px 12px; border-radius:12px;">X</button>
      </div>

      <div class="miniBody" style="gap:12px;">
        <div class="muted" style="font-size:14px;">
          Drag categories to reorder walking order. You can add/rename/delete categories here.
          Deleting a category moves any items using it to <b>Misc</b>.
        </div>

        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <input id="catNewName" type="text" placeholder="New category name (e.g., Paper Goods)" style="flex:1; min-width:220px;">
          <button id="catAddBtn" class="secondary" type="button">+ Add</button>
        </div>

        <div id="catList"></div>

        <div class="smallNote">
          Tip: Categories are stored locally per device. If you want to sync categories between devices, export ALL and import on the other device.
        </div>
      </div>

      <div class="miniBtns">
        <button id="catDone" class="secondary" type="button">Done</button>
      </div>
    </div>
  </div>

  <script>
  // =========================
  // Consistency: Build / Version
  // =========================
  const APP_VERSION = 67;

  // =========================
  // Smart one-time migration helper
  // =========================
  function smartMigrateLocalStorage({ maxLookback = 25 } = {}) {
    const newKey = `groceryApp_v${APP_VERSION}`;
    const flagKey = `groceryApp_migrated_to_${newKey}`;

    if (localStorage.getItem(newKey)) return false;
    if (localStorage.getItem(flagKey) === "1") return false;

    for (let v = APP_VERSION - 1; v >= Math.max(1, APP_VERSION - maxLookback); v--) {
      const oldKey = `groceryApp_v${v}`;
      const oldData = localStorage.getItem(oldKey);
      if (!oldData) continue;

      try {
        JSON.parse(oldData);
        localStorage.setItem(newKey, oldData);
        localStorage.setItem(flagKey, "1");
        console.log(`[MIGRATE] Copied ${oldKey} -> ${newKey}`);
        return true;
      } catch (e) {
        console.warn(`[MIGRATE] Invalid data in ${oldKey}, skipping`, e);
      }
    }
    return false;
  }

  smartMigrateLocalStorage();

  // Service worker registration
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("sw.js").catch(console.warn);
  }

  // =========================
  // Build constants
  // =========================
  const LS_KEY = `groceryApp_v${APP_VERSION}`;
  const UNITS = ["ea","lb","oz","gal","ct"];

  // =========================
  // DEFAULT CATEGORIES (code-shipped)
  //   - Users can add/rename/reorder locally
  //   - Deleting a category reassigns items to DEFAULT_MISC_ID
  // =========================
  const DEFAULT_MISC_ID = "misc";
  const DEFAULT_CATEGORIES = [
    { id:"produce", label:"Produce" },
    { id:"deli", label:"Deli" },
    { id:"bakery", label:"Bakery" },
    { id:"seafood", label:"Seafood" },
    { id:"beef", label:"Beef" },
    { id:"pork", label:"Pork" },
    { id:"chicken", label:"Chicken" },
    { id:"dairy", label:"Dairy" },
    { id:"cheese", label:"Cheese" },
    { id:"beer-wine", label:"Beer/Wine" },
    { id:"beverages", label:"Beverages" },
    { id:"snacks", label:"Snacks" },
    { id:"frozen", label:"Frozen" },
    { id:"household", label:"Household" },
    { id:"baking", label:"Baking" },
    { id:"can-vegies", label:"Can Vegies" },
    { id:"can-meat", label:"Can Meat" },
    { id:"condiments", label:"Condiments" },
    { id:"bread", label:"Bread" },
    { id:"pet", label:"Pet" },
    { id:"pharmacy", label:"Pharmacy" },
    { id:DEFAULT_MISC_ID, label:"Misc" }
  ];

  // =========================
  // Helpers
  // =========================
  function loadState() {
    try { return JSON.parse(localStorage.getItem(LS_KEY)) || null; }
    catch { return null; }
  }
  function saveState(s) { localStorage.setItem(LS_KEY, JSON.stringify(s)); }
  function newBlankList(name) { return { name, items: [], created: Date.now() }; }
  function money(n) { return (Math.round((n||0)*100)/100).toFixed(2); }

  function generateId() {
    if (crypto.randomUUID) return crypto.randomUUID();
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
      const r = Math.random() * 16 | 0;
      return (c === 'x' ? r : (r & 0x3 | 0x8)).toString(16);
    });
  }

  function escapeHtml(s) {
    return String(s ?? "").replace(/[&<>"']/g, m => ({
      "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#039;"
    }[m]));
  }

  function normName(s){ return String(s ?? "").trim().replace(/\s+/g, " "); }

  function slugifyLabel(label){
    const s = normName(label).toLowerCase()
      .replace(/&/g, "and")
      .replace(/[^a-z0-9]+/g, "-")
      .replace(/^-+|-+$/g, "");
    return s || ("cat-" + generateId().slice(0,8));
  }

  // =========================
  // State
  // =========================
  let state = loadState() || {
    current: newBlankList("Today"),
    dishCatalog: [],
    currentMenu: [],
    masterGroceries: [],
    upcDB: {},
    deviceName: "",
    // NEW (v67): user category store
    categoriesUser: [],      // [{id,label}]
    categoryOrder: []        // [id,id,id...] (walking order)
  };

  // Ensure deviceName exists
  if(typeof state.deviceName !== "string"){
    state.deviceName = "";
  }
  if(!state.deviceName.trim()){
    const plat = (navigator.platform || "").replace(/\s+/g," ").trim();
    state.deviceName = plat ? plat : "My Device";
    saveState(state);
  }

  // PHASE 2: per-menu "Add Ingredients" checkboxes (default UNCHECKED)
  if(!state.menuAddFlags || typeof state.menuAddFlags !== "object"){
    state.menuAddFlags = {};
    saveState(state);
  }

  // =========================
  // CATEGORY SYSTEM (v67)
  // =========================
  function ensureCategorySystem(){
    // Ensure containers
    if(!Array.isArray(state.categoriesUser)) state.categoriesUser = [];
    if(!Array.isArray(state.categoryOrder)) state.categoryOrder = [];

    // Ensure Misc exists in defaults (and order)
    const defIds = DEFAULT_CATEGORIES.map(c => c.id);

    // If order is empty, initialize to defaults
    if(state.categoryOrder.length === 0){
      state.categoryOrder = [...defIds];
      saveState(state);
      return;
    }

    // Ensure all default ids exist in order (append missing)
    let changed = false;
    defIds.forEach(id => {
      if(!state.categoryOrder.includes(id)){
        state.categoryOrder.push(id);
        changed = true;
      }
    });

    // Ensure all user cats exist in order (append missing)
    state.categoriesUser.forEach(c => {
      if(c && c.id && !state.categoryOrder.includes(c.id)){
        state.categoryOrder.push(c.id);
        changed = true;
      }
    });

    // Remove any unknown ids from order
    const knownSet = new Set([...defIds, ...state.categoriesUser.map(c=>c.id)]);
    const beforeLen = state.categoryOrder.length;
    state.categoryOrder = state.categoryOrder.filter(id => knownSet.has(id));
    if(state.categoryOrder.length !== beforeLen) changed = true;

    // Ensure Misc is last-ish if it exists but got removed accidentally
    if(!state.categoryOrder.includes(DEFAULT_MISC_ID)){
      state.categoryOrder.push(DEFAULT_MISC_ID);
      changed = true;
    }

    if(changed) saveState(state);
  }

  function allCategoriesMap(){
    const m = new Map();
    DEFAULT_CATEGORIES.forEach(c => m.set(c.id, { ...c, source:"default" }));
    (state.categoriesUser||[]).forEach(c => {
      if(!c || !c.id) return;
      const label = normName(c.label);
      if(!label) return;
      m.set(c.id, { id:c.id, label, source:"user" });
    });
    // Safety: ensure misc exists
    if(!m.has(DEFAULT_MISC_ID)){
      m.set(DEFAULT_MISC_ID, { id:DEFAULT_MISC_ID, label:"Misc", source:"default" });
    }
    return m;
  }

  function getOrderedCategories(){
    ensureCategorySystem();
    const m = allCategoriesMap();
    const out = [];
    (state.categoryOrder||[]).forEach(id => {
      const c = m.get(id);
      if(c) out.push(c);
    });

    // Add any cats missing from order at end (shouldn‚Äôt happen, but safe)
    m.forEach(c => {
      if(!out.some(x => x.id === c.id)) out.push(c);
    });

    return out;
  }

  function catLabelById(id){
    const m = allCategoriesMap();
    const c = m.get(id);
    if(c) return c.label;
    return "Misc";
  }

  // Convert old "cat":"Dairy" string to catId where possible
  function catIdFromLegacyLabel(label){
    const t = normName(label || "").toLowerCase();
    if(!t) return DEFAULT_MISC_ID;

    // Try defaults first
    for(const c of DEFAULT_CATEGORIES){
      if(normName(c.label).toLowerCase() === t) return c.id;
    }

    // Then user cats
    for(const c of (state.categoriesUser||[])){
      if(normName(c.label).toLowerCase() === t) return c.id;
    }

    // If unknown, create a NEW user category to preserve data
    // (This prevents losing someone‚Äôs old category name)
    const newLabel = normName(label);
    if(newLabel){
      const idBase = slugifyLabel(newLabel);
      let id = idBase;
      const m = allCategoriesMap();
      if(m.has(id)){
        id = idBase + "-" + generateId().slice(0,4);
      }
      state.categoriesUser.push({ id, label:newLabel });
      if(!state.categoryOrder.includes(id)) state.categoryOrder.push(id);
      saveState(state);
      return id;
    }

    return DEFAULT_MISC_ID;
  }

  function normalizeItemCategoryFields(){
    // Shopping list items: support both old (cat) and new (catId)
    (state.current?.items || []).forEach(it => {
      if(!it) return;

      // If new field exists, keep it
      if(it.catId && typeof it.catId === "string"){
        // keep legacy label in it.cat for older UI (optional)
        it.cat = catLabelById(it.catId);
        return;
      }

      // Legacy cat string -> catId
      const legacy = it.cat || "Misc";
      it.catId = catIdFromLegacyLabel(legacy);
      it.cat = catLabelById(it.catId);
    });

    // Master groceries
    (state.masterGroceries || []).forEach(m => {
      if(!m) return;

      if(m.catId && typeof m.catId === "string"){
        m.cat = catLabelById(m.catId);
        return;
      }
      const legacy = m.cat || "Misc";
      m.catId = catIdFromLegacyLabel(legacy);
      m.cat = catLabelById(m.catId);
    });

    // Dish ingredients
    (state.dishCatalog || []).forEach(d => {
      const ings = Array.isArray(d?.ingredients) ? d.ingredients : [];
      ings.forEach(i => {
        if(!i) return;

        if(i.catId && typeof i.catId === "string"){
          i.cat = catLabelById(i.catId);
          return;
        }

        const legacy = i.cat || "Misc";
        i.catId = catIdFromLegacyLabel(legacy);
        i.cat = catLabelById(i.catId);
      });
    });

    // UPC DB
    if(state.upcDB && typeof state.upcDB === "object"){
      Object.keys(state.upcDB).forEach(code => {
        const entry = state.upcDB[code];
        if(!entry || typeof entry !== "object") return;

        if(entry.catId && typeof entry.catId === "string"){
          entry.cat = catLabelById(entry.catId);
          return;
        }

        const legacy = entry.cat || "Misc";
        entry.catId = catIdFromLegacyLabel(legacy);
        entry.cat = catLabelById(entry.catId);
      });
    }

    saveState(state);
  }

  function categoryIndexById(catId){
    ensureCategorySystem();
    const i = (state.categoryOrder || []).indexOf(catId || DEFAULT_MISC_ID);
    return i === -1 ? (state.categoryOrder.length + 999) : i;
  }

  function sortByCatThenName(a, b){
    const ai = categoryIndexById(a.catId || DEFAULT_MISC_ID);
    const bi = categoryIndexById(b.catId || DEFAULT_MISC_ID);
    if(ai !== bi) return ai - bi;
    const an = normName(a.name).toLowerCase();
    const bn = normName(b.name).toLowerCase();
    if(an < bn) return -1;
    if(an > bn) return 1;
    return 0;
  }

  function showToast(message, duration = 2000) {
    const div = document.createElement('div');
    div.textContent = message;
    div.style.cssText = `
      position: fixed; top: 80px; left: 50%; transform: translateX(-50%);
      background: #111827; color: white; padding: 12px 24px;
      border-radius: 12px; z-index: 10000; font-weight: 700;
      box-shadow: 0 4px 12px rgba(0,0,0,0.25); pointer-events: none;
      max-width: calc(100vw - 24px); text-align:center;
    `;
    document.body.appendChild(div);
    setTimeout(() => div.remove(), duration);
  }

  function computeTotal() {
    return state.current.items.reduce((sum, it) => {
      const p = parseFloat(it.price) || 0;
      const q = parseFloat(it.qty) || 1;
      return sum + p * q;
    }, 0);
  }

  function sameItem(a, b){
    const an = normName(a.name).toLowerCase();
    const bn = normName(b.name).toLowerCase();

    const ac = (a.catId || catIdFromLegacyLabel(a.cat || "Misc"));
    const bc = (b.catId || catIdFromLegacyLabel(b.cat || "Misc"));

    return an === bn && ac === bc;
  }

  function hasItem(arr, cand){ return arr.some(x => sameItem(x, cand)); }

  // Dish helpers
  function sameDishName(a, b){
    return normName(a).toLowerCase() === normName(b).toLowerCase();
  }
  function hasDish(arr, name){
    return (arr||[]).some(x => sameDishName(x, name));
  }

  // Safe key encoding for dataset attributes
  function dishKey(name){ return encodeURIComponent(String(name ?? "")); }
  function undishKey(k){
    try { return decodeURIComponent(String(k ?? "")); } catch { return String(k ?? ""); }
  }

  // =========================
  // PHASE 1: Dish object migration (SAFE / INVISIBLE)
  // =========================
  (function migrateDishData(){
    let changed = false;

    // Ensure dishCatalog entries are objects with ingredients[]
    state.dishCatalog = (state.dishCatalog || []).map(d => {
      if (typeof d === "string") {
        changed = true;
        return { name: d, ingredients: [] };
      }
      if (!d || typeof d !== "object") {
        changed = true;
        return { name: String(d ?? ""), ingredients: [] };
      }
      if (!("name" in d)) {
        changed = true;
        d.name = String(d.name ?? "");
      }
      if (!Array.isArray(d.ingredients)) {
        changed = true;
        d.ingredients = [];
      }
      return d;
    }).filter(d => normName(d.name));

    // Ensure currentMenu is array of dish names (strings)
    state.currentMenu = (state.currentMenu || [])
      .map(d => typeof d === "string" ? d : d?.name)
      .filter(Boolean);

    if (changed) {
      console.log("[PHASE 1] Dish data migrated");
      saveState(state);
    }
  })();

  // Initialize category system + migrate old cat strings to catId fields
  ensureCategorySystem();
  normalizeItemCategoryFields();

  let lastAddedId = null;
  let renderTimeout = null;

  // =========================
  // Add/Edit Item Modal
  // =========================
  const miniBg = document.getElementById("miniBg");
  const miniTitle = document.getElementById("miniTitle");
  const miniName = document.getElementById("miniName");
  const miniCat = document.getElementById("miniCat");
  let miniResolve = null;

  function buildCatOptions(selectedCatId){
    const cats = getOrderedCategories();
    const sel = selectedCatId || DEFAULT_MISC_ID;
    miniCat.innerHTML = cats.map(c => `
      <option value="${escapeHtml(c.id)}" ${c.id===sel?"selected":""}>${escapeHtml(c.label)}</option>
    `).join("");
  }

  function openItemModal(title, defaults = {name:"", catId:DEFAULT_MISC_ID}){
    miniTitle.textContent = title;
    miniName.value = defaults.name || "";
    buildCatOptions(defaults.catId || DEFAULT_MISC_ID);
    miniBg.style.display = "flex";
    setTimeout(()=> miniName.focus(), 80);
    return new Promise(resolve => { miniResolve = resolve; });
  }

  function closeItemModal(result){
    miniBg.style.display = "none";
    const r = miniResolve;
    miniResolve = null;
    if(r) r(result);
  }

  document.getElementById("miniClose").onclick = () => closeItemModal(null);
  document.getElementById("miniCancel").onclick = () => closeItemModal(null);
  document.getElementById("miniOk").onclick = () => {
    const name = normName(miniName.value);
    const catId = normName(miniCat.value) || DEFAULT_MISC_ID;
    if(!name){
      showToast("Please enter a name", 1600);
      miniName.focus();
      return;
    }
    closeItemModal({ name, catId });
  };
  miniBg.onclick = e => { if(e.target === miniBg) closeItemModal(null); };

  // =========================
  // PHASE 2: Dish Ingredients Modal
  // =========================
  const dishBg = document.getElementById("dishBg");
  const dishTitle = document.getElementById("dishTitle");
  const dishIngList = document.getElementById("dishIngList");

  let dishEditingName = null;
  let dishEditingSnapshot = null;

  function buildCatSelect(selectedCatId){
    const cats = getOrderedCategories();
    const sel = selectedCatId || DEFAULT_MISC_ID;
    return `
      <select class="ingCat">
        ${cats.map(c => `<option value="${escapeHtml(c.id)}" ${c.id===sel?"selected":""}>${escapeHtml(c.label)}</option>`).join("")}
      </select>
    `;
  }

  function addIngRow({name="", catId=DEFAULT_MISC_ID} = {}){
    const row = document.createElement("div");
    row.className = "ingRow";
    row.innerHTML = `
      <input class="ingName" type="text" placeholder="Ingredient name" value="${escapeHtml(name)}">
      ${buildCatSelect(catId || DEFAULT_MISC_ID)}
      <button class="delBtn" type="button" title="Remove">üóëÔ∏è</button>
    `;
    row.querySelector(".delBtn").onclick = () => row.remove();
    dishIngList.appendChild(row);
  }

  function openDishIngredientsModal(dishName){
    const dish = getDishObjByName(dishName);
    if(!dish){
      showToast("Dish not found in catalog.", 1600);
      return;
    }

    dishEditingName = dish.name;
    dishEditingSnapshot = JSON.stringify(dish.ingredients || []);

    dishTitle.textContent = `Ingredients: ${dish.name}`;
    dishIngList.innerHTML = "";

    const ings = Array.isArray(dish.ingredients) ? dish.ingredients : [];
    if(ings.length){
      ings.forEach(x => addIngRow({ name: x.name, catId: x.catId || catIdFromLegacyLabel(x.cat||"Misc") }));
    }

    dishBg.style.display = "flex";
  }

  function closeDishModal(save){
    if(!dishEditingName){
      dishBg.style.display = "none";
      return;
    }

    const dish = getDishObjByName(dishEditingName);
    if(!dish){
      dishBg.style.display = "none";
      dishEditingName = null;
      return;
    }

    if(!save){
      // restore snapshot
      try { dish.ingredients = JSON.parse(dishEditingSnapshot || "[]"); }
      catch { dish.ingredients = dish.ingredients || []; }
      dishBg.style.display = "none";
      dishEditingName = null;
      dishEditingSnapshot = null;
      return;
    }

    // collect rows
    const out = [];
    dishIngList.querySelectorAll(".ingRow").forEach(r => {
      const n = normName(r.querySelector(".ingName")?.value || "");
      const cId = normName(r.querySelector(".ingCat")?.value || DEFAULT_MISC_ID) || DEFAULT_MISC_ID;
      if(!n) return;
      out.push({ name: n, catId: cId, cat: catLabelById(cId) });
    });

    // de-dupe within dish by name+catId
    const seen = new Set();
    dish.ingredients = out.filter(x => {
      const k = normName(x.name).toLowerCase() + "|" + (x.catId||DEFAULT_MISC_ID);
      if(seen.has(k)) return false;
      seen.add(k);
      return true;
    });

    saveState(state);
    debouncedRender();

    dishBg.style.display = "none";
    dishEditingName = null;
    dishEditingSnapshot = null;

    showToast("Ingredients saved.", 1400);
  }

  document.getElementById("dishAddIng").onclick = () => addIngRow({name:"", catId:DEFAULT_MISC_ID});
  document.getElementById("dishClose").onclick = () => closeDishModal(false);
  document.getElementById("dishCancel").onclick = () => closeDishModal(false);
  document.getElementById("dishSave").onclick = () => closeDishModal(true);
  dishBg.onclick = (e) => { if(e.target === dishBg) closeDishModal(false); };

  // =========================
  // Groceries: Shopping list
  // =========================
  function addItemToCurrent(name, catId=DEFAULT_MISC_ID){
    name = normName(name);
    catId = normName(catId) || DEFAULT_MISC_ID;
    if(!name) return false;

    const item = { id: generateId(), name, catId, cat: catLabelById(catId), done:false, qty:"1", unit:"ea", price:"" };
    if(hasItem(state.current.items, item)) return false;

    state.current.items.push(item);
    lastAddedId = item.id;
    saveState(state);
    debouncedRender();
    return true;
  }

  function deleteItemById(id) {
    const idx = state.current.items.findIndex(x => x.id === id);
    if (idx === -1) return;
    state.current.items.splice(idx, 1);
    if (lastAddedId === id) lastAddedId = null;
    saveState(state);
    debouncedRender();
  }

  function updateItem(id, changes) {
    const item = state.current.items.find(x => x.id === id);
    if (!item) return;

    // If category changes, keep both catId and cat label in sync
    if(Object.prototype.hasOwnProperty.call(changes, "catId")){
      const newId = normName(changes.catId) || DEFAULT_MISC_ID;
      changes.catId = newId;
      changes.cat = catLabelById(newId);
    }

    Object.assign(item, changes);
    saveState(state);
    debouncedRender();
  }

  // =========================
  // Groceries: Master list
  // =========================
  function addToMaster(name, catId=DEFAULT_MISC_ID){
    name = normName(name);
    catId = normName(catId) || DEFAULT_MISC_ID;
    if(!name) return false;

    const entry = { name, catId, cat: catLabelById(catId) };
    if(hasItem(state.masterGroceries, entry)) return false;

    state.masterGroceries.push(entry);
    saveState(state);
    debouncedRender();
    return true;
  }

  function removeFromMaster(name, catId){
    const n = normName(name).toLowerCase();
    const c = normName(catId||DEFAULT_MISC_ID);
    state.masterGroceries = state.masterGroceries.filter(x =>
      !(normName(x.name).toLowerCase()===n && normName(x.catId||DEFAULT_MISC_ID)===c)
    );
    saveState(state);
    debouncedRender();
  }

  // =========================
  // Dishes
  // =========================
  function getDishObjByName(name){
    const n = normName(name).toLowerCase();
    return (state.dishCatalog || []).find(d => normName(d.name).toLowerCase() === n) || null;
  }

  function hasDishObjByName(name){
    const n = normName(name).toLowerCase();
    return (state.dishCatalog || []).some(d => normName(d.name).toLowerCase() === n);
  }

  function addDishToCatalogAndMenu(name){
    name = normName(name);
    if(!name) return {addedCatalog:false, addedMenu:false};

    let addedCatalog = false, addedMenu = false;

    // ensure catalog stores objects
    if(!hasDishObjByName(name)){
      state.dishCatalog.push({ name, ingredients: [] });
      addedCatalog = true;
    }

    // menu stays as strings (dish names)
    if(!hasDish(state.currentMenu, name)){
      state.currentMenu.push(name);
      addedMenu = true;
    }

    // default unchecked
    if(!state.menuAddFlags) state.menuAddFlags = {};
    state.menuAddFlags[name] = false;

    saveState(state);
    debouncedRender();
    return {addedCatalog, addedMenu};
  }

  function removeDishFromMenu(name){
    const n = normName(name).toLowerCase();
    state.currentMenu = (state.currentMenu || []).filter(x => normName(x).toLowerCase() !== n);
    saveState(state);
    debouncedRender();
  }

  function removeDishFromCatalog(name){
    const n = normName(name).toLowerCase();
    state.dishCatalog = (state.dishCatalog || []).filter(d => normName(d.name).toLowerCase() !== n);
    state.currentMenu = (state.currentMenu || []).filter(x => normName(x).toLowerCase() !== n);
    if(state.menuAddFlags) delete state.menuAddFlags[name];
    saveState(state);
    debouncedRender();
  }

  function randomMenu14(){
    const pool = [...(state.dishCatalog || [])];
    for(let i=pool.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [pool[i], pool[j]] = [pool[j], pool[i]];
    }
    // ‚úÖ menu is strings
    state.currentMenu = pool.slice(0, 14).map(d => d.name);

    // reset menu checkboxes for the new menu (default UNCHECKED)
    state.menuAddFlags = {};
    state.currentMenu.forEach(n => state.menuAddFlags[n] = false);

    saveState(state);
    debouncedRender();
  }

  function debouncedRender() {
    clearTimeout(renderTimeout);
    renderTimeout = setTimeout(render, 60);
  }

  // =========================
  // Add Ingredients from checked menu dishes
  // (also auto-UNcheck after adding)  ‚úÖ v65 behavior
  // =========================
  function addIngredientsForCheckedMenu(){
    let dishesChecked = 0;
    let ingAdded = 0;
    let ingAlready = 0;
    let ingMissing = 0;

    const menuRows = Array.from(document.querySelectorAll("#menuCard .dishRow"));

    // dishName -> checked?
    const checkedMap = {};
    menuRows.forEach(row => {
      const key = row.dataset.key || "";
      const name = undishKey(key);
      const chk = row.querySelector(".ingCheck");
      checkedMap[name] = !!chk?.checked;
    });

    state.currentMenu.forEach(dishName => {
      const isChecked = Object.prototype.hasOwnProperty.call(checkedMap, dishName)
        ? checkedMap[dishName]
        : !!state.menuAddFlags?.[dishName];

      if(!isChecked) return;

      dishesChecked++;

      const dish = getDishObjByName(dishName);
      const ings = dish?.ingredients || [];
      if(!ings.length){
        ingMissing++;
        return;
      }

      ings.forEach(ing => {
        const n = normName(ing.name);
        const cId = normName(ing.catId || catIdFromLegacyLabel(ing.cat||"Misc")) || DEFAULT_MISC_ID;
        if(!n) return;

        // Always add to Master
        addToMaster(n, cId);

        // Add to current shopping list (qty=1, unit=ea)
        const ok = addItemToCurrent(n, cId);
        if(ok){
          const it = state.current.items.find(x =>
            normName(x.name).toLowerCase()===n.toLowerCase()
            && normName(x.catId||DEFAULT_MISC_ID)===cId
          );
          if(it){
            it.qty = "1";
            it.unit = "ea";
          }
          ingAdded++;
        } else {
          ingAlready++;
        }
      });
    });

    // ‚úÖ Auto-uncheck the menu dishes after adding ingredients (your request)
    menuRows.forEach(row => {
      const chk = row.querySelector(".ingCheck");
      if(chk && chk.checked){
        chk.checked = false;
      }
      const name = undishKey(row.dataset.key || "");
      if(state.menuAddFlags && name) state.menuAddFlags[name] = false;
    });

    saveState(state);
    debouncedRender();

    if(dishesChecked === 0){
      showToast("No dishes checked.", 1600);
      return;
    }

    const msg =
      `Checked dishes: ${dishesChecked} ‚Ä¢ Added: ${ingAdded}` +
      (ingAlready ? ` ‚Ä¢ Already: ${ingAlready}` : "") +
      (ingMissing ? ` ‚Ä¢ No ingredients: ${ingMissing}` : "");

    showToast(msg, 2600);
  }

  // =========================
  // Render
  // =========================
  function renderGroceries() {
    document.getElementById("listName").textContent = state.current.name;
    document.getElementById("total").textContent = money(computeTotal());

    const sortedCurrent = [...state.current.items].sort((a,b) => sortByCatThenName(a,b));
    const card = document.getElementById("listCard");

    if (sortedCurrent.length === 0) {
      card.innerHTML = `<div style="padding:16px; text-align:center;">
        <div class="muted">No items yet.</div>
        <div class="muted">Tap <b>SCAN QR</b>, <b>SCAN UPC</b>, or <b>Add Item</b>.</div>
      </div>`;
    } else {
      card.innerHTML = sortedCurrent.map(it => `
        <div class="item ${it.done ? "done":""}" data-id="${it.id}">
          <input class="check" type="checkbox" ${it.done ? "checked":""}>
          <div class="name">${escapeHtml(it.name)}</div>
          <span class="catPill">${escapeHtml(catLabelById(it.catId || DEFAULT_MISC_ID))}</span>
          <input class="qty" type="number" step="0.5" min="0" value="${escapeHtml(it.qty)}">
          <select class="unit">
            ${UNITS.map(u => `<option ${u===it.unit?"selected":""}>${escapeHtml(u)}</option>`).join("")}
          </select>
          <input class="price" type="number" step="0.01" min="0" placeholder="$" value="${escapeHtml(it.price)}">
          <button class="delBtn" title="Delete">üóëÔ∏è</button>
        </div>
      `).join("");

      card.querySelectorAll(".item").forEach(row => {
        const id = row.dataset.id;
        const item = state.current.items.find(x => x.id === id);
        if (!item) return;

        row.querySelector(".check").onchange = e => updateItem(id, { done: e.target.checked });

        row.querySelector(".qty").onchange = e => {
          let v = parseFloat(e.target.value) || 0;
          v = Math.max(0, Math.min(999, v));
          updateItem(id, { qty: String(v) });
        };

        row.querySelector(".unit").onchange = e => updateItem(id, { unit: e.target.value });

        row.querySelector(".price").onchange = e => {
          let v = parseFloat(e.target.value);
          updateItem(id, { price: isNaN(v) ? "" : String(Math.max(0, v)) });
        };

        row.querySelector(".delBtn").onclick = () => deleteItemById(id);

        row.querySelector(".name").onclick = async () => {
          const res = await openItemModal("Edit Item", { name: item.name, catId: item.catId || DEFAULT_MISC_ID writeNo??? });
        };
      });
    }

    // Master list
    const sortedMaster = [...state.masterGroceries].sort((a,b)=>sortByCatThenName(a,b));
    document.getElementById("masterCount").textContent = sortedMaster.length;

    const masterCard = document.getElementById("masterCard");
    if(sortedMaster.length === 0){
      masterCard.innerHTML = `<div style="padding:14px; text-align:center;">
        <div class="muted">Master list is empty.</div>
        <div class="muted">Scan QR/UPC or add items to build your master list.</div>
      </div>`;
    } else {
      masterCard.innerHTML = sortedMaster.map((m, idx) => `
        <div class="masterRow" data-idx="${idx}">
          <input class="mCheck" type="checkbox">
          <div class="mName">${escapeHtml(m.name)}</div>
          <span class="catPill">${escapeHtml(catLabelById(m.catId || DEFAULT_MISC_ID))}</span>
          <button class="delBtn" title="Delete from Master">üóëÔ∏è</button>
        </div>
      `).join("");

      const rows = Array.from(masterCard.querySelectorAll(".masterRow"));
      rows.forEach(row => {
        const idx = parseInt(row.dataset.idx, 10);
        const m = sortedMaster[idx];
        if(!m) return;

        row.querySelector(".mName").onclick = async () => {
          const res = await openItemModal("Edit Master Item", { name: m.name, catId: m.catId || DEFAULT_MISC_ID });
          if(!res) return;
          removeFromMaster(m.name, m.catId || DEFAULT_MISC_ID);
          addToMaster(res.name, res.catId);
          showToast("Master item updated.", 1500);
        };

        row.querySelector(".delBtn").onclick = () => {
          const ok = confirm(`Delete from Master?\n\n${m.name} (${catLabelById(m.catId||DEFAULT_MISC_ID)})`);
          if(!ok) return;
          removeFromMaster(m.name, m.catId || DEFAULT_MISC_ID);
        };
      });
    }
  }

  // FIX: Resume missing code continuation from grocery row onclick edit (the earlier placeholder)
  function bindGroceryEditHandlers(){
    const card = document.getElementById("listCard");
    card.querySelectorAll(".item").forEach(row => {
      const id = row.dataset.id;
      const item = state.current.items.find(x => x.id === id);
      if(!item) return;

      const nameEl = row.querySelector(".name");
      if(!nameEl) return;

      nameEl.onclick = async () => {
        const res = await openItemModal("Edit Item", { name: item.name, catId: item.catId || DEFAULT_MISC_ID });
        if(!res) return;

        const cand = { name: res.name, catId: res.catId };
        const others = state.current.items.filter(x => x.id !== id);
        if(hasItem(others, cand)){
          showToast("That item already exists in the Shopping List.", 1900);
          return;
        }
        updateItem(id, { name: res.name, catId: res.catId });
      };
    });
  }

  function dishRowHtml(name, where){
    const dish = getDishObjByName(name);
    const hasIng = !!(dish && Array.isArray(dish.ingredients) && dish.ingredients.length);

    const menuControls = (where === "menu") ? `
      <label style="display:flex;align-items:center;gap:8px; font-weight:900;">
        <input class="ingCheck" type="checkbox" ${state.menuAddFlags?.[name] ? "checked":""}>
        <span title="${hasIng ? "Has ingredients" : "No ingredients yet"}" style="font-size:18px; opacity:${hasIng ? "1":"0.35"};">üßÇ</span>
      </label>
    ` : `
      <span title="${hasIng ? "Has ingredients" : "No ingredients yet"}" style="font-size:18px; opacity:${hasIng ? "1":"0.35"};">üßÇ</span>
    `;

    return `
      <div class="dishRow" data-key="${dishKey(name)}" data-where="${where}">
        <div style="display:flex; align-items:center; gap:12px;">
          ${menuControls}
          <div class="dishName">${escapeHtml(name)}</div>
        </div>

        <div style="display:flex; gap:8px; align-items:center;">
          ${where==="menu" ? `<span class="pill ok">MENU</span>` : `<span class="pill">CATALOG</span>`}
          <button class="delBtn" title="Delete">üóëÔ∏è</button>
        </div>
      </div>
    `;
  }

  function renderDishes(){
    document.getElementById("menuCount").textContent = (state.currentMenu || []).length;
    document.getElementById("catalogCount").textContent = (state.dishCatalog || []).length;

    const menuCard = document.getElementById("menuCard");
    if(!state.currentMenu || state.currentMenu.length === 0){
      menuCard.innerHTML = `<div style="padding:16px; text-align:center;">
        <div class="muted">Menu is empty.</div>
        <div class="muted">Scan a dish QR or tap <b>Random Menu (14)</b>.</div>
      </div>`;
    } else {
      menuCard.innerHTML = state.currentMenu.map(d => dishRowHtml(d, "menu")).join("");
    }

    const catalogCard = document.getElementById("catalogCard");
    if(!state.dishCatalog || state.dishCatalog.length === 0){
      catalogCard.innerHTML = `<div style="padding:16px; text-align:center;">
        <div class="muted">Catalog is empty.</div>
        <div class="muted">Scan dish QR codes to build it.</div>
      </div>`;
    } else {
      catalogCard.innerHTML = state.dishCatalog.map(d => dishRowHtml(d.name, "catalog")).join("");
    }

    function bindDishRows(container){
      container.querySelectorAll(".dishRow").forEach(row=>{
        const name = undishKey(row.dataset.key || "");
        const where = row.dataset.where;

        // Checkbox handler
        const chk = row.querySelector(".ingCheck");
        if(chk){
          chk.checked = !!state.menuAddFlags?.[name];

          chk.onchange = (e) => {
            e.stopPropagation();
            if(!state.menuAddFlags) state.menuAddFlags = {};
            state.menuAddFlags[name] = !!chk.checked;
            saveState(state);
          };

          chk.onclick = (e) => e.stopPropagation();
        }

        row.querySelector(".dishName").onclick = () => {
          if(where === "catalog"){
            addDishToCatalogAndMenu(name);
            return;
          }

          // where === "menu"
          const allowed = !!row.querySelector(".ingCheck")?.checked;

          if(allowed){
            openDishIngredientsModal(name);
            return;
          }

          // Rename behavior when NOT checked
          const newName = prompt("Rename dish (updates Catalog + Menu):", name);
          if(!newName) return;
          const nn = normName(newName);
          if(!nn) return;

          removeDishFromCatalog(name);
          addDishToCatalogAndMenu(nn);

          if(state.menuAddFlags){
            delete state.menuAddFlags[name];
            state.menuAddFlags[nn] = false;
            saveState(state);
          }
        };

        row.querySelector(".delBtn").onclick = () => {
          if(where === "menu"){
            const choice = prompt(`Delete "${name}"?\nType:\nM = remove from Menu only\nC = remove from Catalog (also removes from Menu)\n(Anything else cancels)`, "M");
            if(!choice) return;
            const ch = choice.trim().toUpperCase();
            if(ch === "M") removeDishFromMenu(name);
            else if(ch === "C") removeDishFromCatalog(name);
          } else {
            const choice = prompt(`Delete "${name}"?\nType:\nC = remove from Catalog (also removes from Menu)\nM = remove from Menu only\n(Anything else cancels)`, "C");
            if(!choice) return;
            const ch = choice.trim().toUpperCase();
            if(ch === "C") removeDishFromCatalog(name);
            else if(ch === "M") removeDishFromMenu(name);
          }
        };
      });
    }

    bindDishRows(menuCard);
    bindDishRows(catalogCard);
  }

  function render(){
    renderGroceries();
    bindGroceryEditHandlers(); // v67: keeps edit hook clean after render rebuild
    renderDishes();
    renderTools();
  }

  // =========================
  // Tabs / Screens
  // =========================
  const tabGroceries = document.getElementById("tabGroceries");
  const tabDishes = document.getElementById("tabDishes");
  const screenGroceries = document.getElementById("screenGroceries");
  const screenDishes = document.getElementById("screenDishes");
  const screenTools = document.getElementById("screenTools");
  const btnMore = document.getElementById("btnMore");

  function showTab(which){
    const isG = which === "groceries";
    const isD = which === "dishes";
    const isT = which === "tools";

    screenGroceries.style.display = isG ? "" : "none";
    screenDishes.style.display   = isD ? "" : "none";
    screenTools.style.display    = isT ? "" : "none";

    tabGroceries.classList.toggle("active", isG);
    tabDishes.classList.toggle("active", isD);

    // Top-right action: only for groceries
    document.getElementById("btnClearDone").style.display = isG ? "" : "none";

    // ‚ãØ button only on groceries (as requested)
    btnMore.style.display = isG ? "" : "none";
  }

  tabGroceries.onclick = () => showTab("groceries");
  tabDishes.onclick = () => showTab("dishes");

  btnMore.onclick = () => showTab("tools");
  document.getElementById("btnToolsBack").onclick = () => showTab("groceries");

  // =========================
  // Grocery actions
  // =========================
  document.getElementById("btnNew").onclick = () => {
    const name = prompt("List name?", state.current.name);
    if (!name?.trim()) return;
    state.current = newBlankList(name.trim());
    lastAddedId = null;
    saveState(state);
    render();
  };

  document.getElementById("btnAdd").onclick = async () => {
    const res = await openItemModal("Add Item", { name:"", catId:DEFAULT_MISC_ID });
    if(!res) return;

    addToMaster(res.name, res.catId);

    const also = confirm(`Add to Current Shopping List too?\n\n${res.name} (${catLabelById(res.catId)})`);
    if(also){
      const ok = addItemToCurrent(res.name, res.catId);
      showToast(ok ? `Added: ${res.name}` : `Already in Shopping List: ${res.name}`, 1800);
    } else {
      showToast(`Added to Master only: ${res.name}`, 1800);
    }
  };

  document.getElementById("btnUndo").onclick = () => {
    if (lastAddedId) deleteItemById(lastAddedId);
  };

  document.getElementById("btnClearDone").onclick = () => {
    const before = state.current.items.length;
    state.current.items = state.current.items.filter(x => !x.done);
    if (state.current.items.length !== before) {
      saveState(state);
      render();
    }
  };

  document.getElementById("btnMasterAddSelected").onclick = () => {
    const masterCard = document.getElementById("masterCard");
    const rows = Array.from(masterCard.querySelectorAll(".masterRow"));
    if(rows.length === 0) return;

    let added = 0;
    let already = 0;

    rows.forEach(r => {
      const cb = r.querySelector(".mCheck");
      if(!cb || !cb.checked) return;

      const name = r.querySelector(".mName")?.textContent || "";
      // cat id is not stored in DOM; use pill label -> id lookup (safe)
      const catLabel = r.querySelector(".catPill")?.textContent || "Misc";
      const catId = catIdFromLegacyLabel(catLabel);

      const ok = addItemToCurrent(name, catId);
      if(ok) added++; else already++;

      cb.checked = false;
    });

    if(added === 0 && already === 0){
      showToast("No items checked.", 1600);
    } else {
      const msg = `Added ${added} item(s)` + (already ? ` (${already} already in list)` : "");
      showToast(msg, 2200);
    }
  };

  document.getElementById("btnMasterClearChecks").onclick = () => {
    document.querySelectorAll("#masterCard .mCheck").forEach(cb => cb.checked = false);
    showToast("Master checks cleared.", 1400);
  };

  document.getElementById("btnMasterClear").onclick = () => {
    if(!confirm("Clear the entire Master Grocery List?")) return;
    state.masterGroceries = [];
    saveState(state);
    render();
  };

  // =========================
  // Dish actions
  // =========================
  document.getElementById("btnRandom14").onclick = () => {
    if(!state.dishCatalog || state.dishCatalog.length === 0){
      alert("Catalog is empty. Scan some dish QR codes first.");
      return;
    }
    randomMenu14();
  };

  document.getElementById("btnAddCheckedIng").onclick = () => {
    addIngredientsForCheckedMenu();
  };

  document.getElementById("btnClearMenu").onclick = () => {
    if(!confirm("Clear the current menu?")) return;
    state.currentMenu = [];
    // also clear menu flags
    state.menuAddFlags = {};
    saveState(state);
    render();
  };

  document.getElementById("btnClearCatalog").onclick = () => {
    if(!confirm("Clear the entire Dish Catalog AND Menu?")) return;
    state.dishCatalog = [];
    state.currentMenu = [];
    state.menuAddFlags = {};
    saveState(state);
    render();
  };

  document.getElementById("btnAddDish").onclick = () => {
    const name = prompt("Enter dish name:");
    if (!name) return;
    const normalized = normName(name);
    if (!normalized) {
      showToast("Please enter a valid dish name", 1800);
      return;
    }
    const result = addDishToCatalogAndMenu(normalized);
    showToast((result.addedCatalog || result.addedMenu) ? `Added dish: ${normalized}` : `Already exists: ${normalized}`, 1800);
  };

  // =========================
  // Scanner logic (QR + UPC modes)
  // =========================
  const modalBg = document.getElementById("modalBg");
  const scanMsgEl = document.getElementById("scanMsg");
  const scanTitleEl = document.getElementById("scanTitle");
  const scanHintEl = document.getElementById("scanHint");
  let qr = null;

  let scanMode = "qr";
  let pending = null;
  let targetLocked = false;
  let audioCtx = null;

  function beep() {
    try {
      if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.type = "sine"; osc.frequency.value = 880;
      gain.gain.value = 0.06;
      osc.connect(gain); gain.connect(audioCtx.destination);
      osc.start();
      setTimeout(() => osc.stop(), 90);
    } catch {}
  }

  function setScanMsg(text, cls = "") {
    scanMsgEl.textContent = text;
    scanMsgEl.className = "scanMsg" + (cls ? ` ${cls}` : "");
  }

  function resetTarget() {
    pending = null;
    targetLocked = false;
    document.getElementById("btnCapture").disabled = true;
    setScanMsg("Point camera at code ‚Äì hold steady‚Ä¶");
  }

  function parseQR(decodedText){
    let raw = String(decodedText ?? "");
    raw = raw.replace(/\uFEFF/g, "");
    raw = raw.replace(/\r\n/g, "\n").trim();
    raw = raw.slice(0, 2000);

    if(!raw) return { kind:"unknown", raw:"" };

    const maybeDecode = (s) => {
      s = String(s ?? "");
      if (/%[0-9A-Fa-f]{2}/.test(s)) {
        try { return decodeURIComponent(s); } catch {}
      }
      return s;
    };

    const lower = raw.toLowerCase();

    try {
      if (/^[a-z]+:\/\//i.test(raw)) {
        const url = new URL(raw);

        const dish = url.searchParams.get("dish");
        if (dish) return { kind:"dish", name: maybeDecode(dish).trim().slice(0,120), raw };

        const item = url.searchParams.get("item");
        const cat  = url.searchParams.get("cat");
        if (item) return {
          kind:"item",
          name: maybeDecode(item).trim().slice(0,120),
          // cat can be either label or id; we‚Äôll treat it as label for now
          cat:  maybeDecode(cat||"").trim().slice(0,80),
          raw
        };

        const text = url.searchParams.get("text");
        if (text) return parseQR(maybeDecode(text).trim());
      }
    } catch {}

    const dishMatch = raw.match(/(?:^|[?&\s])dish=([^&\n]+)/i);
    if (dishMatch) {
      const name = maybeDecode(dishMatch[1]).trim();
      return { kind:"dish", name: name.slice(0,120), raw };
    }

    const itemMatch = raw.match(/(?:^|[?&\s])item=([^&\n]+)/i);
    if (itemMatch) {
      const start = lower.indexOf("item=");
      const qs = raw.slice(start);
      const sp = new URLSearchParams(q
