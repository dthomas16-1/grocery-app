<!-- =========================
     index.html  (BUILD 039)
     ========================= -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Grocery APP</title>
  <link rel="manifest" href="manifest.webmanifest">

  <style>
    html, body { overflow-x: hidden; margin:0; }
    * { box-sizing: border-box; }

    /* ‚úÖ Put variables FIRST so var(--soft) / var(--ink) always resolve */
    :root{
      --navy:#0b1220;
      --blue:#2563eb;
      --blue2:#1d4ed8;
      --green:#16a34a;
      --green2:#15803d;
      --orange:#f59e0b;
      --orange2:#d97706;
      --red:#ef4444;
      --red2:#dc2626;

      --card:#ffffff;
      --ink:#0f172a;
      --muted:#64748b;
      --soft:#eef2ff;         /* soft background tint */
      --border:rgba(15,23,42,.10);
      --shadow: 0 10px 24px rgba(2,6,23,.10);
    }

    body{
      font-family: Arial, Helvetica, sans-serif;
      /* ‚úÖ fallbacks so page never goes ‚Äúblank‚Äù if vars fail */
      background: linear-gradient(180deg, #f6f7fb 0%, var(--soft, #eef2ff) 100%);
      color: var(--ink, #0f172a);
    }

    header{
      padding:14px 16px;
      background: linear-gradient(90deg, #0b1220 0%, #111827 55%, #0b1220 100%);
      color:#fff;
      font-weight:800;
      font-size:18px;
      border-bottom: 1px solid rgba(255,255,255,.08);
    }

    .wrap { padding:14px 14px 90px; max-width:820px; margin:0 auto; }
    .row { display:flex; gap:10px; flex-wrap:wrap; }

    button{
      appearance:none;
      border:0;
      border-radius:16px;
      padding:14px 16px;
      font-size:16px;
      font-weight:900;
      cursor:pointer;
      background: var(--blue);
      color:#fff;
      box-shadow: 0 10px 18px rgba(37,99,235,.20);
      transition: transform .06s ease, filter .12s ease;
    }
    button:active{ transform: translateY(1px); }
    button:hover{ filter: brightness(1.03); }
    button:disabled{ opacity:.55; cursor:not-allowed; box-shadow:none; }

    button.secondary { background:#e5e7eb; color:#111827; }
    button.secondary,
    button.tabBtn{ box-shadow: none; }

    button.danger { background:#fee2e2; color:#7f1d1d; }

    .tabs { display:flex; gap:10px; flex-wrap:wrap; margin-bottom:12px; }
    .tabBtn { background:#e5e7eb; color:#111827; }
    .tabBtn.active { background:#111827; color:#fff; }

    button.scanQR{
      background: linear-gradient(180deg, var(--blue) 0%, var(--blue2) 100%);
    }

    button.scanUPC{
      background: linear-gradient(180deg, var(--orange) 0%, var(--orange2) 100%);
      box-shadow: 0 10px 18px rgba(245,158,11,.22);
    }

    button.danger{
      background: linear-gradient(180deg, var(--red) 0%, var(--red2) 100%);
      color:#fff;
    }

    .card{
      background: var(--card);
      border-radius:18px;
      padding:12px;
      margin-top:12px;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
    }

    .muted { color:#6b7280; }
    .spacer { height:10px; }

    /* Grocery list rows */
    .item {
      display:flex; align-items:center; gap:10px;
      padding:10px 6px; border-bottom:1px solid #eee;
    }
    .item:last-child { border-bottom:0; }
    .check { width:26px; height:26px; }
    .name { flex:1; font-size:16px; cursor:pointer; }
    .done .name { text-decoration: line-through; opacity:.55; }
    .qty { width:64px; padding:8px 10px; border:1px solid #ddd; border-radius:12px; font-size:16px; }
    select { padding:8px 10px; border:1px solid #ddd; border-radius:12px; font-size:16px; background:#fff; }
    .price { width:96px; padding:8px 10px; border:1px solid #ddd; border-radius:12px; font-size:16px; }
    .total { font-weight:900; font-size:18px; }
    .delBtn {
      background:#fee2e2; color:#7f1d1d;
      padding:10px 12px; border-radius:12px; font-weight:900;
      box-shadow:none;
    }
    .catPill{
      font-size:12px; font-weight:900;
      padding:6px 10px; border-radius:999px;
      background:#e5e7eb; color:#111827;
      white-space:nowrap;
    }

    /* Master list rows */
    .masterRow{
      display:flex; align-items:center; gap:10px;
      padding:10px 6px; border-bottom:1px solid #eee;
    }
    .masterRow:last-child{ border-bottom:0; }
    .mName{ flex:1; font-size:16px; cursor:pointer; font-weight:800; }
    .mCheck{ width:26px; height:26px; }

    /* Dish list rows */
    .dishRow{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:10px 6px; border-bottom:1px solid #eee;
    }
    .dishRow:last-child{ border-bottom:0; }
    .dishName{ font-size:16px; font-weight:800; cursor:pointer; }
    .pill{ font-size:12px; font-weight:900; padding:6px 10px; border-radius:999px; background:#e5e7eb; color:#111827; }
    .pill.ok{ background:rgba(34,197,94,.18); color:#065f46; }
    .pill.warn{ background:rgba(245,158,11,.18); color:#92400e; }

    /* Scanner modal */
    .modalBg {
      position:fixed; inset:0; background:rgba(0,0,0,.55);
      display:none; align-items:center; justify-content:center; padding:16px;
      z-index: 9999;
    }
    .modal {
      width:min(760px, 100%);
      max-width: calc(100vw - 32px);
      background:#fff; border-radius:18px; overflow:hidden;
      box-shadow: 0 20px 60px rgba(0,0,0,.35);
      max-height: calc(100dvh - 32px);
      display:flex; flex-direction:column;
    }
    .modalHead {
      display:flex; justify-content:space-between; align-items:center;
      padding:12px 14px; background:#111827; color:#fff;
    }
    .modalBody {
      padding:12px; display:flex; flex-direction:column; gap:10px;
      overflow-y:auto; overscroll-behavior: contain;
      padding-bottom: env(safe-area-inset-bottom, 12px);
    }
    #reader {
      width:100%; max-height:50dvh; overflow:hidden; border-radius:16px; background:#000;
    }
    #reader * { max-width:100% !important; box-sizing:border-box; }
    #reader video,
    #reader canvas {
      width:100% !important; height:auto !important;
      max-height:50dvh !important; object-fit:contain;
      border-radius:16px; display:block;
    }
    .hint { color:#6b7280; font-size:14px; margin-top:0; }
    .scanBar {
      margin-top:10px; background:rgba(17,24,39,.06);
      border:1px solid rgba(17,24,39,.10); border-radius:14px;
      padding:10px 12px; display:flex; align-items:center;
      justify-content:space-between; gap:10px; flex-wrap:wrap;
      position:sticky; bottom:0; z-index:5; background:#fff;
      box-shadow:0 -6px 18px rgba(0,0,0,.06);
    }
    .scanMsg {
      font-weight:900; font-size:16px; color:#111827;
      flex:1; min-width:0; overflow-wrap:anywhere;
    }
    .scanMsg.ok { color:#065f46; }
    .scanMsg.warn { color:#92400e; }
    .scanBtns { display:flex; gap:10px; flex-wrap:wrap; flex:0 0 auto; }
    .capBtn { background:#16a34a; }
    .doneBtn { background:#e5e7eb; color:#111827; }

    /* Add/Edit modal */
    .miniBg{
      position:fixed; inset:0; background:rgba(0,0,0,.55);
      display:none; align-items:center; justify-content:center; padding:16px;
      z-index: 9998;
    }
    .mini{
      width:min(520px, 100%);
      background:#fff; border-radius:18px; overflow:hidden;
      box-shadow:0 20px 60px rgba(0,0,0,.35);
    }
    .miniHead{
      padding:12px 14px; background:#111827; color:#fff;
      display:flex; justify-content:space-between; align-items:center;
      font-weight:900;
    }
    .miniBody{ padding:12px 14px; display:flex; flex-direction:column; gap:10px; }
    .miniRow{ display:flex; flex-direction:column; gap:6px; }
    .miniRow label{ font-weight:900; color:#111827; }
    .miniRow input, .miniRow select{
      width:100%; padding:12px 12px; border:1px solid #ddd;
      border-radius:14px; font-size:16px;
    }
    .miniBtns{ display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; padding:0 14px 14px; }
  </style>

  <script src="https://unpkg.com/html5-qrcode"></script>
</head>

<body>
  <header>Grocery APP <span style="opacity:.7;font-weight:600;">(build 039 ‚Äì master + QR + UPC scan modes)</span></header>

  <div class="wrap">
    <div class="tabs">
      <button id="tabGroceries" class="tabBtn active">Groceries</button>
      <button id="tabDishes" class="tabBtn">Dishes</button>
    </div>

    <!-- GROCERIES TAB -->
    <div id="screenGroceries">
      <div class="row">
        <button id="btnNew">New List</button>
        <button id="btnScan" class="scanQR">SCAN QR</button>
        <button id="btnScanUPC" class="scanUPC">SCAN UPC</button>
        <button id="btnUndo" class="secondary">Undo</button>
        <button id="btnClearDone" class="secondary">Clear Purchased</button>
        <button id="btnAdd" class="secondary">Add Item</button>
      </div>

      <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;">
          <div>
            <b>Shopping List:</b> <span id="listName">Today</span><br>
            <span class="muted">Sorted by category walking order + name.</span>
          </div>
          <div class="total">Total: $<span id="total">0.00</span></div>
        </div>
      </div>

      <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;">
          <div>
            <b>Master Grocery List:</b>
            <span class="pill"><span id="masterCount">0</span> items</span>
          </div>
          <div class="muted">Check items here, then tap <b>ADD SELECTED</b>.</div>
        </div>

        <div class="spacer"></div>

        <div class="row">
          <button id="btnMasterAddSelected" class="secondary">ADD SELECTED</button>
          <button id="btnMasterClearChecks" class="secondary">CLEAR CHECKS</button>
          <button id="btnMasterClear" class="danger">Clear Master</button>
        </div>

        <div class="spacer"></div>
        <div id="masterCard"></div>
      </div>

      <div class="card" id="listCard"></div>
    </div>

    <!-- DISHES TAB -->
    <div id="screenDishes" style="display:none;">
      <div class="row">
        <button id="btnScanDish">SCAN DISH</button>
        <button id="btnAddDish" class="secondary">Add Dish</button>
        <button id="btnRandom14" class="secondary">Random Menu (14)</button>
        <button id="btnClearMenu" class="secondary">Clear Menu</button>
        <button id="btnClearCatalog" class="danger">Clear Catalog</button>
      </div>

      <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;">
          <div><b>Current Menu:</b> <span class="pill ok"><span id="menuCount">0</span> dishes</span></div>
          <div class="muted">Scanning a dish adds it to Menu + Catalog.</div>
        </div>
      </div>
      <div class="card" id="menuCard"></div>

      <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;">
          <div><b>Dish Catalog:</b> <span class="pill"><span id="catalogCount">0</span> total</span></div>
          <div class="muted">Tap a dish to rename; delete button removes menu/catalog.</div>
        </div>
      </div>
      <div class="card" id="catalogCard"></div>
    </div>
  </div>

  <!-- Scanner Modal -->
  <div class="modalBg" id="modalBg">
    <div class="modal">
      <div class="modalHead">
        <div><b id="scanTitle">Scan</b></div>
        <button id="btnCloseTop" class="secondary" style="padding:10px 12px; border-radius:12px;">Close</button>
      </div>
      <div class="modalBody">
        <div id="reader"></div>
        <div class="scanBar">
          <div id="scanMsg" class="scanMsg">Point camera at code ‚Äì hold steady‚Ä¶</div>
          <div class="scanBtns">
            <button id="btnCapture" class="capBtn" disabled>CAPTURE</button>
            <button id="btnDone" class="doneBtn">DONE</button>
          </div>
        </div>
        <div class="hint" id="scanHint">
          Tip: Fill the capture box with the code and hold steady.
        </div>
      </div>
    </div>
  </div>

  <!-- Add/Edit Item Modal (category dropdown only shows here) -->
  <div class="miniBg" id="miniBg">
    <div class="mini">
      <div class="miniHead">
        <div id="miniTitle">Add Item</div>
        <button id="miniClose" class="secondary" style="padding:10px 12px; border-radius:12px;">X</button>
      </div>
      <div class="miniBody">
        <div class="miniRow">
          <label for="miniName">Item name</label>
          <input id="miniName" type="text" placeholder="e.g., Milk" />
        </div>
        <div class="miniRow">
          <label for="miniCat">Category</label>
          <select id="miniCat"></select>
        </div>
      </div>
      <div class="miniBtns">
        <button id="miniCancel" class="secondary">Cancel</button>
        <button id="miniOk">OK</button>
      </div>
    </div>
  </div>

  <script>
  // =========================
  // Consistency: Build / Version
  // =========================
  const APP_VERSION = 39;

  // Service worker registration (kept simple and reliable)
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("sw.js").catch(console.warn);
  }

  // =========================
  // Build 039 constants
  // =========================
  const LS_KEY = `groceryApp_v${APP_VERSION}`;
  const UNITS = ["ea","lb","oz","gal","ct"];

  // Category walking order (edit this list to change sort order)
  const CATEGORIES = [
    "Produce",
    "Deli",
    "Sea food",
    "Beef",
    "Pork",
    "Chicken",
    "Dairy",
    "Cheese",
    "Beverages",
    "Snacks",
    "Frozen",
    "Household",
    "Bread",
    "Pet",
    "Pharmacy",
    "Misc"
  ];

  // =========================
  // Helpers
  // =========================
  function loadState() {
    try { return JSON.parse(localStorage.getItem(LS_KEY)) || null; }
    catch { return null; }
  }
  function saveState(s) { localStorage.setItem(LS_KEY, JSON.stringify(s)); }

  function newBlankList(name) { return { name, items: [], created: Date.now() }; }

  function money(n) { return (Math.round((n||0)*100)/100).toFixed(2); }

  function generateId() {
    if (crypto.randomUUID) return crypto.randomUUID();
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
      const r = Math.random() * 16 | 0;
      return (c === 'x' ? r : (r & 0x3 | 0x8)).toString(16);
    });
  }

  function escapeHtml(s) {
    return String(s ?? "").replace(/[&<>"']/g, m => ({
      "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#039;"
    }[m]));
  }

  function normName(s){
    return String(s ?? "").trim().replace(/\s+/g, " ");
  }

  function catIndex(cat){
    const i = CATEGORIES.findIndex(x => x.toLowerCase() === String(cat||"").toLowerCase());
    return i === -1 ? CATEGORIES.length + 999 : i;
  }

  function sortByCatThenName(a, b){
    const ai = catIndex(a.cat);
    const bi = catIndex(b.cat);
    if(ai !== bi) return ai - bi;
    const an = normName(a.name).toLowerCase();
    const bn = normName(b.name).toLowerCase();
    if(an < bn) return -1;
    if(an > bn) return 1;
    return 0;
  }

  function showToast(message, duration = 2000) {
    const div = document.createElement('div');
    div.textContent = message;
    div.style.cssText = `
      position: fixed; top: 80px; left: 50%; transform: translateX(-50%);
      background: #111827; color: white; padding: 12px 24px;
      border-radius: 12px; z-index: 10000; font-weight: 700;
      box-shadow: 0 4px 12px rgba(0,0,0,0.25); pointer-events: none;
      max-width: calc(100vw - 24px); text-align:center;
    `;
    document.body.appendChild(div);
    setTimeout(() => div.remove(), duration);
  }

  function computeTotal() {
    return state.current.items.reduce((sum, it) => {
      const p = parseFloat(it.price) || 0;
      const q = parseFloat(it.qty) || 1;
      return sum + p * q;
    }, 0);
  }

  function sameItem(a, b){
    // Duplicate logic: name match (case-insensitive) AND category match (case-insensitive)
    const an = normName(a.name).toLowerCase();
    const bn = normName(b.name).toLowerCase();
    const ac = normName(a.cat||"Misc").toLowerCase();
    const bc = normName(b.cat||"Misc").toLowerCase();
    return an === bn && ac === bc;
  }

  function hasItem(arr, cand){
    return arr.some(x => sameItem(x, cand));
  }

  // =========================
  // State
  // =========================
  let state = loadState() || {
    current: newBlankList("Today"),
    dishCatalog: [],
    currentMenu: [],
    masterGroceries: [], // array of { name, cat }
    upcDB: {}            // map: upc -> { name, cat }
  };

  let lastAddedId = null;
  let renderTimeout = null;

  // =========================
  // Add/Edit Item Modal (category dropdown only here)
  // =========================
  const miniBg = document.getElementById("miniBg");
  const miniTitle = document.getElementById("miniTitle");
  const miniName = document.getElementById("miniName");
  const miniCat = document.getElementById("miniCat");
  let miniResolve = null;

  function buildCatOptions(selected){
    miniCat.innerHTML = CATEGORIES.map(c => `<option ${String(selected||"").toLowerCase()===c.toLowerCase()?"selected":""}>${escapeHtml(c)}</option>`).join("");
  }

  function openItemModal(title, defaults = {name:"", cat:"Misc"}){
    miniTitle.textContent = title;
    miniName.value = defaults.name || "";
    buildCatOptions(defaults.cat || "Misc");
    miniBg.style.display = "flex";
    setTimeout(()=> miniName.focus(), 80);
    return new Promise(resolve => { miniResolve = resolve; });
  }

  function closeItemModal(result){
    miniBg.style.display = "none";
    const r = miniResolve;
    miniResolve = null;
    if(r) r(result);
  }

  document.getElementById("miniClose").onclick = () => closeItemModal(null);
  document.getElementById("miniCancel").onclick = () => closeItemModal(null);
  document.getElementById("miniOk").onclick = () => {
    const name = normName(miniName.value);
    const cat = normName(miniCat.value) || "Misc";
    if(!name){
      showToast("Please enter a name", 1600);
      miniName.focus();
      return;
    }
    closeItemModal({ name, cat });
  };
  miniBg.onclick = e => { if(e.target === miniBg) closeItemModal(null); };

  // =========================
  // Groceries: Shopping list
  // =========================
  function addItemToCurrent(name, cat="Misc"){
    name = normName(name);
    cat = normName(cat) || "Misc";
    if(!name) return false;

    const item = { id: generateId(), name, cat, done:false, qty:"1", unit:"ea", price:"" };

    // prevent duplicates in CURRENT list
    if(hasItem(state.current.items, item)) return false;

    state.current.items.push(item);
    lastAddedId = item.id;
    saveState(state);
    debouncedRender();
    return true;
  }

  function deleteItemById(id) {
    const idx = state.current.items.findIndex(x => x.id === id);
    if (idx === -1) return;
    state.current.items.splice(idx, 1);
    if (lastAddedId === id) lastAddedId = null;
    saveState(state);
    debouncedRender();
  }

  function updateItem(id, changes) {
    const item = state.current.items.find(x => x.id === id);
    if (!item) return;
    Object.assign(item, changes);
    saveState(state);
    debouncedRender();
  }

  // =========================
  // Groceries: Master list
  // =========================
  function addToMaster(name, cat="Misc"){
    name = normName(name);
    cat = normName(cat) || "Misc";
    if(!name) return false;

    const entry = { name, cat };
    if(hasItem(state.masterGroceries, entry)) return false;

    state.masterGroceries.push(entry);
    saveState(state);
    debouncedRender();
    return true;
  }

  function removeFromMaster(name, cat){
    const n = normName(name).toLowerCase();
    const c = normName(cat||"Misc").toLowerCase();
    state.masterGroceries = state.masterGroceries.filter(x =>
      !(normName(x.name).toLowerCase()===n && normName(x.cat||"Misc").toLowerCase()===c)
    );
    saveState(state);
    debouncedRender();
  }

  // =========================
  // Dishes (unchanged behavior)
  // =========================
  function hasDish(arr, name){
    const n = normName(name).toLowerCase();
    return arr.some(x => normName(x).toLowerCase() === n);
  }

  function addDishToCatalogAndMenu(name){
    name = normName(name);
    if(!name) return {addedCatalog:false, addedMenu:false};

    let addedCatalog = false, addedMenu = false;

    if(!hasDish(state.dishCatalog, name)){
      state.dishCatalog.push(name);
      addedCatalog = true;
    }
    if(!hasDish(state.currentMenu, name)){
      state.currentMenu.push(name);
      addedMenu = true;
    }

    saveState(state);
    debouncedRender();
    return {addedCatalog, addedMenu};
  }

  function removeDishFromMenu(name){
    const n = normName(name).toLowerCase();
    state.currentMenu = state.currentMenu.filter(x => normName(x).toLowerCase() !== n);
    saveState(state);
    debouncedRender();
  }

  function removeDishFromCatalog(name){
    const n = normName(name).toLowerCase();
    state.dishCatalog = state.dishCatalog.filter(x => normName(x).toLowerCase() !== n);
    state.currentMenu = state.currentMenu.filter(x => normName(x).toLowerCase() !== n);
    saveState(state);
    debouncedRender();
  }

  function randomMenu14(){
    const pool = [...state.dishCatalog];
    for(let i=pool.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [pool[i], pool[j]] = [pool[j], pool[i]];
    }
    state.currentMenu = pool.slice(0, 14);
    saveState(state);
    debouncedRender();
  }

  function debouncedRender() {
    clearTimeout(renderTimeout);
    renderTimeout = setTimeout(render, 60);
  }

  // =========================
  // Render
  // =========================
  function renderGroceries() {
    document.getElementById("listName").textContent = state.current.name;
    document.getElementById("total").textContent = money(computeTotal());

    // Sort current list by walking order + name
    const sortedCurrent = [...state.current.items].sort((a,b) => sortByCatThenName(a,b));

    const card = document.getElementById("listCard");
    if (sortedCurrent.length === 0) {
      card.innerHTML = `<div style="padding:16px; color:#6b7280; text-align:center;">
        No items yet.<br>Tap <b>SCAN QR</b>, <b>SCAN UPC</b>, or <b>Add Item</b>.
      </div>`;
    } else {
      card.innerHTML = sortedCurrent.map(it => `
        <div class="item ${it.done ? "done":""}" data-id="${it.id}">
          <input class="check" type="checkbox" ${it.done ? "checked":""}>
          <div class="name">${escapeHtml(it.name)}</div>
          <span class="catPill">${escapeHtml(it.cat||"Misc")}</span>
          <input class="qty" type="number" step="0.5" min="0" value="${escapeHtml(it.qty)}">
          <select class="unit">
            ${UNITS.map(u => `<option ${u===it.unit?"selected":""}>${escapeHtml(u)}</option>`).join("")}
          </select>
          <input class="price" type="number" step="0.01" min="0" placeholder="$" value="${escapeHtml(it.price)}">
          <button class="delBtn" title="Delete">üóëÔ∏è</button>
        </div>
      `).join("");

      card.querySelectorAll(".item").forEach(row => {
        const id = row.dataset.id;
        const item = state.current.items.find(x => x.id === id);
        if (!item) return;

        row.querySelector(".check").onchange = e => updateItem(id, { done: e.target.checked });

        row.querySelector(".qty").onchange = e => {
          let v = parseFloat(e.target.value) || 0;
          v = Math.max(0, Math.min(999, v));
          updateItem(id, { qty: String(v) });
        };

        row.querySelector(".unit").onchange = e => updateItem(id, { unit: e.target.value });

        row.querySelector(".price").onchange = e => {
          let v = parseFloat(e.target.value);
          updateItem(id, { price: isNaN(v) ? "" : String(Math.max(0, v)) });
        };

        row.querySelector(".delBtn").onclick = () => deleteItemById(id);

        // Edit name+category (dropdown only in modal)
        row.querySelector(".name").onclick = async () => {
          const res = await openItemModal("Edit Item", { name: item.name, cat: item.cat || "Misc" });
          if(!res) return;

          // prevent duplicates after edit
          const cand = { name: res.name, cat: res.cat };
          const others = state.current.items.filter(x => x.id !== id);
          if(hasItem(others, cand)){
            showToast("That item already exists in the Shopping List.", 1900);
            return;
          }

          updateItem(id, { name: res.name, cat: res.cat });
        };
      });
    }

    // Master list
    const sortedMaster = [...state.masterGroceries].sort((a,b)=>sortByCatThenName(a,b));
    document.getElementById("masterCount").textContent = sortedMaster.length;

    const masterCard = document.getElementById("masterCard");
    if(sortedMaster.length === 0){
      masterCard.innerHTML = `<div style="padding:14px; color:#6b7280; text-align:center;">
        Master list is empty.<br>Scan QR/UPC or add items to build your master list.
      </div>`;
    } else {
      masterCard.innerHTML = sortedMaster.map((m, idx) => `
        <div class="masterRow" data-idx="${idx}">
          <input class="mCheck" type="checkbox">
          <div class="mName">${escapeHtml(m.name)}</div>
          <span class="catPill">${escapeHtml(m.cat||"Misc")}</span>
          <button class="delBtn" title="Delete from Master">üóëÔ∏è</button>
        </div>
      `).join("");

      // Bind actions
      const rows = Array.from(masterCard.querySelectorAll(".masterRow"));
      rows.forEach(row => {
        const idx = parseInt(row.dataset.idx, 10);
        const m = sortedMaster[idx];
        if(!m) return;

        // Tap master name -> edit master entry
        row.querySelector(".mName").onclick = async () => {
          const res = await openItemModal("Edit Master Item", { name: m.name, cat: m.cat || "Misc" });
          if(!res) return;

          removeFromMaster(m.name, m.cat);
          addToMaster(res.name, res.cat);
          showToast("Master item updated.", 1500);
        };

        // Delete master item
        row.querySelector(".delBtn").onclick = () => {
          const ok = confirm(`Delete from Master?\n\n${m.name} (${m.cat||"Misc"})`);
          if(!ok) return;
          removeFromMaster(m.name, m.cat);
        };
      });
    }
  }

  function dishRowHtml(name, where){
    return `
      <div class="dishRow" data-name="${escapeHtml(name)}" data-where="${where}">
        <div class="dishName">${escapeHtml(name)}</div>
        <div style="display:flex; gap:8px; align-items:center;">
          ${where==="menu" ? `<span class="pill ok">MENU</span>` : `<span class="pill">CATALOG</span>`}
          <button class="delBtn" title="Delete">üóëÔ∏è</button>
        </div>
      </div>
    `;
  }

  function renderDishes(){
    document.getElementById("menuCount").textContent = state.currentMenu.length;
    document.getElementById("catalogCount").textContent = state.dishCatalog.length;

    const menuCard = document.getElementById("menuCard");
    if(state.currentMenu.length === 0){
      menuCard.innerHTML = `<div style="padding:16px; color:#6b7280; text-align:center;">
        Menu is empty.<br>Scan a dish QR or tap <b>Random Menu (14)</b>.
      </div>`;
    } else {
      menuCard.innerHTML = state.currentMenu.map(d => dishRowHtml(d, "menu")).join("");
    }

    const catalogCard = document.getElementById("catalogCard");
    if(state.dishCatalog.length === 0){
      catalogCard.innerHTML = `<div style="padding:16px; color:#6b7280; text-align:center;">
        Catalog is empty.<br>Scan dish QR codes to build it.
      </div>`;
    } else {
      catalogCard.innerHTML = state.dishCatalog.map(d => dishRowHtml(d, "catalog")).join("");
    }

    function bindDishRows(container){
      container.querySelectorAll(".dishRow").forEach(row=>{
        const name = row.dataset.name;
        const where = row.dataset.where;

        row.querySelector(".dishName").onclick = () => {
          if(where === "catalog"){
            addDishToCatalogAndMenu(name);
          } else {
            const newName = prompt("Rename dish (updates Catalog + Menu):", name);
            if(!newName) return;
            const nn = normName(newName);
            if(!nn) return;

            removeDishFromCatalog(name);
            addDishToCatalogAndMenu(nn);
          }
        };

        row.querySelector(".delBtn").onclick = () => {
          if(where === "menu"){
            const choice = prompt(`Delete "${name}"?\nType:\nM = remove from Menu only\nC = remove from Catalog (also removes from Menu)\n(Anything else cancels)`, "M");
            if(!choice) return;
            const ch = choice.trim().toUpperCase();
            if(ch === "M") removeDishFromMenu(name);
            else if(ch === "C") removeDishFromCatalog(name);
          } else {
            const choice = prompt(`Delete "${name}"?\nType:\nC = remove from Catalog (also removes from Menu)\nM = remove from Menu only\n(Anything else cancels)`, "C");
            if(!choice) return;
            const ch = choice.trim().toUpperCase();
            if(ch === "C") removeDishFromCatalog(name);
            else if(ch === "M") removeDishFromMenu(name);
          }
        };
      });
    }

    bindDishRows(menuCard);
    bindDishRows(catalogCard);
  }

  function render(){
    renderGroceries();
    renderDishes();
  }

  // =========================
  // Tabs
  // =========================
  const tabGroceries = document.getElementById("tabGroceries");
  const tabDishes = document.getElementById("tabDishes");
  const screenGroceries = document.getElementById("screenGroceries");
  const screenDishes = document.getElementById("screenDishes");

  function showTab(which){
    const isG = which === "groceries";
    screenGroceries.style.display = isG ? "" : "none";
    screenDishes.style.display = isG ? "none" : "";
    tabGroceries.classList.toggle("active", isG);
    tabDishes.classList.toggle("active", !isG);
  }
  tabGroceries.onclick = () => showTab("groceries");
  tabDishes.onclick = () => showTab("dishes");

  // =========================
  // Grocery actions
  // =========================
  document.getElementById("btnNew").onclick = () => {
    const name = prompt("List name?", state.current.name);
    if (!name?.trim()) return;
    state.current = newBlankList(name.trim());
    lastAddedId = null;
    saveState(state);
    render();
  };

  document.getElementById("btnAdd").onclick = async () => {
    const res = await openItemModal("Add Item", { name:"", cat:"Misc" });
    if(!res) return;

    // Add to master always (helps build it)
    addToMaster(res.name, res.cat);

    // Ask: add to current too?
    const also = confirm(`Add to Current Shopping List too?\n\n${res.name} (${res.cat})`);
    if(also){
      const ok = addItemToCurrent(res.name, res.cat);
      showToast(ok ? `Added: ${res.name}` : `Already in Shopping List: ${res.name}`, 1800);
    } else {
      showToast(`Added to Master only: ${res.name}`, 1800);
    }
  };

  document.getElementById("btnUndo").onclick = () => {
    if (lastAddedId) deleteItemById(lastAddedId);
  };

  document.getElementById("btnClearDone").onclick = () => {
    const before = state.current.items.length;
    state.current.items = state.current.items.filter(x => !x.done);
    if (state.current.items.length !== before) {
      saveState(state);
      render();
    }
  };

  // Master: add selected
  document.getElementById("btnMasterAddSelected").onclick = () => {
    const masterCard = document.getElementById("masterCard");
    const rows = Array.from(masterCard.querySelectorAll(".masterRow"));
    if(rows.length === 0) return;

    let added = 0;
    let already = 0;

    rows.forEach(r => {
      const cb = r.querySelector(".mCheck");
      if(!cb || !cb.checked) return;

      const name = r.querySelector(".mName")?.textContent || "";
      const cat = r.querySelector(".catPill")?.textContent || "Misc";

      const ok = addItemToCurrent(name, cat);
      if(ok) added++; else already++;

      cb.checked = false;
    });

    if(added === 0 && already === 0){
      showToast("No items checked.", 1600);
    } else {
      const msg = `Added ${added} item(s)` + (already ? ` (${already} already in list)` : "");
      showToast(msg, 2200);
    }
  };

  document.getElementById("btnMasterClearChecks").onclick = () => {
    document.querySelectorAll("#masterCard .mCheck").forEach(cb => cb.checked = false);
    showToast("Master checks cleared.", 1400);
  };

  document.getElementById("btnMasterClear").onclick = () => {
    if(!confirm("Clear the entire Master Grocery List?")) return;
    state.masterGroceries = [];
    saveState(state);
    render();
  };

  // =========================
  // Dish actions
  // =========================
  document.getElementById("btnRandom14").onclick = () => {
    if(state.dishCatalog.length === 0){
      alert("Catalog is empty. Scan some dish QR codes first.");
      return;
    }
    randomMenu14();
  };

  document.getElementById("btnClearMenu").onclick = () => {
    if(!confirm("Clear the current menu?")) return;
    state.currentMenu = [];
    saveState(state);
    render();
  };

  document.getElementById("btnClearCatalog").onclick = () => {
    if(!confirm("Clear the entire Dish Catalog AND Menu?")) return;
    state.dishCatalog = [];
    state.currentMenu = [];
    saveState(state);
    render();
  };

  document.getElementById("btnAddDish").onclick = () => {
    const name = prompt("Enter dish name:");
    if (!name) return;
    const normalized = normName(name);
    if (!normalized) {
      showToast("Please enter a valid dish name", 1800);
      return;
    }
    const result = addDishToCatalogAndMenu(normalized);
    showToast((result.addedCatalog || result.addedMenu) ? `Added dish: ${normalized}` : `Already exists: ${normalized}`, 1800);
  };

  // =========================
  // Scanner logic (QR + UPC modes)
  // =========================
  const modalBg = document.getElementById("modalBg");
  const scanMsgEl = document.getElementById("scanMsg");
  const scanTitleEl = document.getElementById("scanTitle");
  const scanHintEl = document.getElementById("scanHint");
  let qr = null;

  // scanMode: "qr" | "upc"
  let scanMode = "qr";

  // Pending payload for CAPTURE
  let pending = null; // { kind:"dish"|"item"|"upc"|"unknown", ... }
  let targetLocked = false;
  let audioCtx = null;

  function beep() {
    try {
      if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.type = "sine"; osc.frequency.value = 880;
      gain.gain.value = 0.06;
      osc.connect(gain); gain.connect(audioCtx.destination);
      osc.start();
      setTimeout(() => osc.stop(), 90);
    } catch {}
  }

  function setScanMsg(text, cls = "") {
    scanMsgEl.textContent = text;
    scanMsgEl.className = "scanMsg" + (cls ? ` ${cls}` : "");
  }

  function resetTarget() {
    pending = null;
    targetLocked = false;
    document.getElementById("btnCapture").disabled = true;
    setScanMsg("Point camera at code ‚Äì hold steady‚Ä¶");
  }

  // QR parsing (dish=..., item=...&cat=...)
  function parseQR(decodedText){
    let raw = String(decodedText ?? "");
    raw = raw.replace(/\uFEFF/g, "");
    raw = raw.replace(/\r\n/g, "\n").trim();
    raw = raw.slice(0, 2000);

    if(!raw) return { kind:"unknown", raw:"" };

    const maybeDecode = (s) => {
      s = String(s ?? "");
      if (/%[0-9A-Fa-f]{2}/.test(s)) {
        try { return decodeURIComponent(s); } catch {}
      }
      return s;
    };

    const lower = raw.toLowerCase();

    // URL support
    try {
      if (/^[a-z]+:\/\//i.test(raw)) {
        const url = new URL(raw);

        const dish = url.searchParams.get("dish");
        if (dish) return { kind:"dish", name: maybeDecode(dish).trim().slice(0,120), raw };

        const item = url.searchParams.get("item");
        const cat  = url.searchParams.get("cat");
        if (item) return {
          kind:"item",
          name: maybeDecode(item).trim().slice(0,120),
          cat:  maybeDecode(cat||"").trim().slice(0,80),
          raw
        };

        const text = url.searchParams.get("text");
        if (text) return parseQR(maybeDecode(text).trim());
      }
    } catch {}

    // Plain dish=
    const dishMatch = raw.match(/(?:^|[?&\s])dish=([^&\n]+)/i);
    if (dishMatch) {
      const name = maybeDecode(dishMatch[1]).trim();
      return { kind:"dish", name: name.slice(0,120), raw };
    }

    // Plain item=
    const itemMatch = raw.match(/(?:^|[?&\s])item=([^&\n]+)/i);
    if (itemMatch) {
      const start = lower.indexOf("item=");
      const qs = raw.slice(start);
      const sp = new URLSearchParams(qs);
      const item = sp.get("item");
      const cat  = sp.get("cat");
      if (item) {
        return {
          kind:"item",
          name: maybeDecode(item).trim().slice(0,120),
          cat:  maybeDecode(cat||"").trim().slice(0,80),
          raw
        };
      }
    }

    return { kind:"unknown", raw: raw.slice(0,140) };
  }

  // UPC parsing: keep digits
  function parseUPC(decodedText){
    let raw = String(decodedText ?? "").trim();
    raw = raw.replace(/[^\d]/g, "");
    raw = raw.slice(0, 32);
    if(!raw) return { kind:"unknown", raw:"" };
    return { kind:"upc", code: raw, raw };
  }

  async function openScanner(mode){
    scanMode = mode;
    modalBg.style.display = "flex";
    resetTarget();
    document.getElementById("reader").innerHTML = "";

    scanTitleEl.textContent = (mode === "upc") ? "Scan UPC" : "Scan QR";
    scanHintEl.textContent  = (mode === "upc")
      ? "Tip: Center the barcode inside the rectangle and hold steady."
      : "Tip: Fill the square with the QR and hold steady.";

    // Formats by mode
    const formats = (mode === "upc")
      ? [
          Html5QrcodeSupportedFormats.UPC_A,
          Html5QrcodeSupportedFormats.UPC_E,
          Html5QrcodeSupportedFormats.EAN_13,
          Html5QrcodeSupportedFormats.EAN_8,
          Html5QrcodeSupportedFormats.CODE_128
        ]
      : [Html5QrcodeSupportedFormats.QR_CODE];

    qr = new Html5Qrcode("reader", {
      verbose: false,
      formatsToSupport: formats,
      experimentalFeatures: { useBarCodeDetectorIfSupported: true }
    });

    try {
      const cameras = await Html5Qrcode.getCameras();
      if (!cameras?.length) throw new Error("No cameras found");

      const rear = cameras.find(c => /back|rear|environment/i.test(c.label)) || cameras[cameras.length-1];

      // Different capture windows by mode:
      const qrboxFunction = (vw, vh) => {
        if(mode === "upc"){
          // UPC mode: rectangle
          return { width: 260, height: 110 };
        } else {
          // QR mode: square
          const size = 70;
          return { width: size, height: size };
        }
      };

      await qr.start(
        rear.id,
        {
          fps: 12,
          qrbox: qrboxFunction,
          disableFlip: false,
          rememberLastUsedCamera: true,
          aspectRatio: 1.777
        },
        onScanSuccess
      );
    } catch (err) {
      setScanMsg("Camera error ‚Äì check permissions / try again.", "warn");
      console.warn("Scanner start failed:", err);
      setTimeout(closeScanner, 2200);
    }
  }

  async function closeScanner() {
    modalBg.style.display = "none";
    resetTarget();

    if (!qr) return;
    try {
      await qr.stop();
      qr.clear();
    } catch (err) {
      console.warn("Scanner cleanup issue:", err);
    } finally {
      qr = null;
      document.getElementById("reader").innerHTML = "";
    }
  }

  function onScanSuccess(decodedText) {
    if (targetLocked) return;
    targetLocked = true;

    pending = (scanMode === "upc") ? parseUPC(decodedText) : parseQR(decodedText);

    if (navigator.vibrate) navigator.vibrate([30, 20, 30]);
    beep();

    document.getElementById("btnCapture").disabled = false;

    if(pending.kind === "dish"){
      setScanMsg(`Detected DISH: ${pending.name} ‚Üí tap Capture`, "ok");
    } else if(pending.kind === "item"){
      const cat = pending.cat ? ` (${pending.cat})` : "";
      setScanMsg(`Detected ITEM: ${pending.name}${cat} ‚Üí tap Capture`, "ok");
    } else if(pending.kind === "upc"){
      setScanMsg(`Detected UPC: ${pending.code} ‚Üí tap Capture`, "ok");
    } else {
      setScanMsg(`Detected: ${pending.raw} ‚Üí tap Capture`, "warn");
    }
  }

  document.getElementById("btnCapture").onclick = async () => {
    if (!pending) return;

    if(pending.kind === "dish"){
      const r = addDishToCatalogAndMenu(pending.name);
      setScanMsg((r.addedCatalog || r.addedMenu) ? `‚úÖ Dish added: ${pending.name}` : `‚ÑπÔ∏è Dish already exists: ${pending.name}`, "ok");
      showTab("dishes");
    }
    else if(pending.kind === "item"){
      const cat = normName(pending.cat) || "Misc";
      addToMaster(pending.name, cat);
      const ok = addItemToCurrent(pending.name, cat);
      setScanMsg(ok ? `‚úÖ Added item: ${pending.name} (${cat})` : `‚ÑπÔ∏è Already in list: ${pending.name} (${cat})`, "ok");
      showTab("groceries");
    }
    else if(pending.kind === "upc"){
      const code = pending.code;

      const known = state.upcDB && state.upcDB[code];
      let entry = known ? { name: known.name, cat: known.cat || "Misc" } : null;

      if(!entry){
        const res = await openItemModal("New UPC Item", { name:"", cat:"Misc" });
        if(!res){
          setScanMsg("UPC captured, but canceled.", "warn");
          document.getElementById("btnCapture").disabled = true;
          setTimeout(resetTarget, 450);
          return;
        }
        entry = { name: res.name, cat: res.cat || "Misc" };

        if(!state.upcDB) state.upcDB = {};
        state.upcDB[code] = { name: entry.name, cat: entry.cat };
        saveState(state);
      }

      addToMaster(entry.name, entry.cat);

      const also = confirm(`UPC: ${code}\n\nItem: ${entry.name} (${entry.cat})\n\nAdd to Current Shopping List too?`);
      if(also){
        const ok = addItemToCurrent(entry.name, entry.cat);
        setScanMsg(ok ? `‚úÖ Added: ${entry.name} (${entry.cat})` : `‚ÑπÔ∏è Already in list: ${entry.name} (${entry.cat})`, "ok");
      } else {
        setScanMsg(`‚úÖ Added to Master only: ${entry.name} (${entry.cat})`, "ok");
      }

      showTab("groceries");
    }
    else {
      const raw = normName(pending.raw);
      if(raw){
        addToMaster(raw, "Misc");
        const also = confirm(`Detected unknown code:\n\n"${raw}"\n\nAdd to Current Shopping List too?`);
        if(also) addItemToCurrent(raw, "Misc");
        setScanMsg(`‚úÖ Saved: ${raw}`, "ok");
        showTab("groceries");
      } else {
        setScanMsg("Nothing detected.", "warn");
      }
    }

    document.getElementById("btnCapture").disabled = true;
    setTimeout(resetTarget, 650);
  };

  // Open scanner buttons
  document.getElementById("btnScan").onclick = () => openScanner("qr");
  document.getElementById("btnScanUPC").onclick = () => openScanner("upc");
  document.getElementById("btnScanDish").onclick = () => openScanner("qr"); // dish uses QR parsing

  document.getElementById("btnCloseTop").onclick = closeScanner;
  document.getElementById("btnDone").onclick = closeScanner;
  modalBg.onclick = e => { if (e.target === modalBg) closeScanner(); };

  // Initial render
  render();
  </script>
</body>
</html>
