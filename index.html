<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Grocery APP</title>
<link rel="manifest" href="manifest.webmanifest">

<!-- OFFLINE XLSX SUPPORT (place locally, optional but recommended) -->
<script src="xlsx.full.min.js"></script>

<style>
html, body { margin:0; overflow-x:hidden; }
* { box-sizing:border-box; }
body { font-family:Arial,Helvetica,sans-serif; background:#f6f7fb; }
header { padding:14px 16px; background:#111827; color:#fff; font-weight:800; font-size:18px; }

.wrap { padding:14px 14px 120px; max-width:920px; margin:0 auto; }
.row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }

button{
  border:0; border-radius:14px; padding:14px 16px;
  font-size:16px; font-weight:900; cursor:pointer;
  background:#2563eb; color:#fff;
}
button.secondary{ background:#e5e7eb; color:#111827; }
button.danger{ background:#fee2e2; color:#7f1d1d; }
button:disabled{ opacity:.5; cursor:not-allowed; }

.tabs{ display:flex; gap:10px; }
.tabBtn{ background:#e5e7eb; color:#111827; }
.tabBtn.active{ background:#111827; color:#fff; }

.card{
  background:#fff; border-radius:16px; padding:12px; margin-top:12px;
  box-shadow:0 6px 18px rgba(0,0,0,.08);
}

.muted{ color:#6b7280; font-size:14px; }
.total{ font-weight:900; font-size:18px; }

.item{
  display:flex; gap:10px; align-items:center;
  padding:10px 6px; border-bottom:1px solid #eee;
}
.item:last-child{ border-bottom:0; }
.check{ width:26px; height:26px; }
.name{ flex:1; cursor:pointer; }
.done .name{ text-decoration:line-through; opacity:.55; }

.qty,.price,select{
  padding:8px 10px; font-size:16px;
  border:1px solid #ddd; border-radius:12px;
}
.qty{ width:64px; }
.price{ width:96px; }

.pill{
  font-size:12px; font-weight:900;
  padding:4px 10px; border-radius:999px;
  background:rgba(17,24,39,.08);
}
.pill.green{ background:rgba(22,163,74,.15); color:#065f46; }

.catRow,.dishRow{
  display:flex; gap:10px; align-items:center;
  padding:10px 6px; border-bottom:1px solid #eee;
}
.catRow:last-child,.dishRow:last-child{ border-bottom:0; }
.catName,.dishName{ flex:1; font-weight:900; cursor:pointer; }

.miniBtn{
  padding:10px 12px; border-radius:12px;
  font-weight:900; background:#e5e7eb;
}

.modalBg{
  position:fixed; inset:0; background:rgba(0,0,0,.55);
  display:none; align-items:center; justify-content:center;
  padding:16px; z-index:9999;
}
.modal{
  width:min(760px,100%); background:#fff; border-radius:18px;
  max-height:calc(100dvh - 32px); overflow:hidden;
  display:flex; flex-direction:column;
}
.modalHead{
  background:#111827; color:#fff;
  padding:12px 14px; display:flex; justify-content:space-between;
}
.modalBody{ padding:12px; display:flex; flex-direction:column; gap:10px; }
#reader{ background:#000; border-radius:16px; overflow:hidden; }

.scanBar{
  display:flex; gap:10px; align-items:center;
  padding:10px 12px; border-radius:14px;
  background:#fff; box-shadow:0 -6px 18px rgba(0,0,0,.06);
  position:sticky; bottom:0;
}
.scanMsg{ font-weight:900; flex:1; }
.scanMsg.warn{ color:#92400e; }
.scanMsg.ok{ color:#065f46; }
.capBtn{ background:#16a34a; }
</style>

<script src="https://unpkg.com/html5-qrcode"></script>
</head>
<body>

<header>
  Grocery APP <span style="opacity:.7;font-weight:600;">(build 011)</span>
</header>

<div class="wrap">

<!-- Tabs -->
<div class="row tabs">
  <button class="tabBtn active" data-tab="groceries">Groceries</button>
  <button class="tabBtn" data-tab="dishes">Dishes</button>
  <button class="tabBtn" data-tab="categories">Categories</button>
</div>

<!-- Groceries -->
<div id="groceriesTab">
  <div class="card">
    <div class="row">
      <button id="btnNew">New List</button>
      <button id="btnScan">SCAN</button>
      <button id="btnUndo" class="secondary">Undo</button>
      <button id="btnClearDone" class="secondary">Clear Purchased</button>
      <button id="btnAdd" class="secondary">Add Item</button>
    </div>
    <div class="row" style="justify-content:space-between;margin-top:8px;">
      <div><b>List:</b> <span id="listName">Today</span></div>
      <div class="total">$<span id="total">0.00</span></div>
    </div>
    <div class="muted">Sorted by universal walking order (Excel + learned)</div>
  </div>
  <div class="card" id="listCard"></div>
</div>

<!-- Dishes -->
<div id="dishesTab" style="display:none;">
  <div class="card">
    <div class="row" style="justify-content:space-between;">
      <div>
        <b>Current Menu</b>
        <div class="muted">Random Menu (14) replaces menu</div>
      </div>
      <button id="btnRandom14">Random Menu (14)</button>
    </div>
    <div id="menuList"></div>
  </div>

  <div class="card">
    <div class="row" style="justify-content:space-between;">
      <b>Dish Catalog</b>
      <button id="btnAddDish" class="secondary">Add Dish</button>
    </div>
    <div id="dishCatalog"></div>
  </div>
</div>

<!-- Categories -->
<div id="categoriesTab" style="display:none;">
  <div class="card">
    <div class="row" style="justify-content:space-between;">
      <b>Categories (Walking Order)</b>
      <label class="miniBtn">
        Import XLSX
        <input id="fileXlsx" type="file" accept=".xlsx" hidden>
      </label>
    </div>
    <div id="catList"></div>
  </div>
</div>

</div>

<!-- Scanner -->
<div class="modalBg" id="modalBg">
  <div class="modal">
    <div class="modalHead">
      <b>Scan QR</b>
      <button id="btnClose" class="secondary">Close</button>
    </div>
    <div class="modalBody">
      <div id="reader"></div>
      <div class="scanBar">
        <div id="scanMsg" class="scanMsg">Point camera at QR…</div>
        <button id="btnCapture" class="capBtn" disabled>CAPTURE</button>
      </div>
    </div>
  </div>
</div>

<script>
/* =========================
   STATE + HELPERS
========================= */
const LS_KEY="groceryApp_v3";
const UNITS=["ea","lb","oz","gal","ct"];
const MISC_NAME="Misc";

function load(){ try{return JSON.parse(localStorage.getItem(LS_KEY))}catch{return null} }
function save(){ localStorage.setItem(LS_KEY,JSON.stringify(state)); }
function norm(s){ return String(s||"").trim().toLowerCase(); }
function id(){ return crypto.randomUUID(); }
function money(n){ return (Math.round((n||0)*100)/100).toFixed(2); }

let state=load()||{
  current:{ name:"Today", items:[] },
  categories:[],
  itemCatalog:{},
  dishCatalog:[],
  menu:[]
};

function getOrCreateMisc(){
  let c=state.categories.find(x=>norm(x.name)===norm(MISC_NAME));
  if(!c){
    c={ id:id(), name:MISC_NAME, sort:state.categories.length };
    state.categories.push(c);
  }
  return c;
}
getOrCreateMisc(); save();

/* =========================
   TABS
========================= */
document.querySelectorAll(".tabBtn").forEach(b=>{
  b.onclick=()=>{
    document.querySelectorAll(".tabBtn").forEach(x=>x.classList.remove("active"));
    b.classList.add("active");
    ["groceries","dishes","categories"].forEach(t=>{
      document.getElementById(t+"Tab").style.display =
        b.dataset.tab===t ? "" : "none";
    });
  };
});

/* =========================
   GROCERIES
========================= */
function addItem(name,catId){
  state.current.items.push({
    id:id(), name, cat:catId, qty:"1", unit:"ea", price:"", done:false
  });
  save(); render();
}

function render(){
  document.getElementById("listName").textContent=state.current.name;
  document.getElementById("total").textContent=money(
    state.current.items.reduce((s,i)=>s+(+i.qty||1)*(+i.price||0),0)
  );

  const misc=getOrCreateMisc();
  const cats=[...state.categories].sort((a,b)=>a.sort-b.sort);

  const items=[...state.current.items].sort((a,b)=>{
    const ca=cats.find(c=>c.id===a.cat)||misc;
    const cb=cats.find(c=>c.id===b.cat)||misc;
    if(ca.sort!==cb.sort) return ca.sort-cb.sort;
    return norm(a.name).localeCompare(norm(b.name));
  });

  const card=document.getElementById("listCard");
  if(!items.length){
    card.innerHTML="<div class='muted'>No items</div>"; return;
  }
  card.innerHTML=items.map(i=>{
    const c=cats.find(x=>x.id===i.cat)||misc;
    return `
    <div class="item ${i.done?"done":""}">
      <input type="checkbox" class="check" ${i.done?"checked":""}
        onchange="i.done=this.checked;save();render()">
      <div class="name" onclick="editItem('${i.id}')">
        ${i.name}<br><span class="pill">${c.name}</span>
      </div>
      <input class="qty" value="${i.qty}"
        onchange="i.qty=this.value;save();render()">
      <select onchange="i.unit=this.value;save()">
        ${UNITS.map(u=>`<option ${u===i.unit?"selected":""}>${u}</option>`)}
      </select>
      <input class="price" value="${i.price}"
        onchange="i.price=this.value;save();render()">
    </div>`;
  }).join("");
}
function editItem(id){
  const i=state.current.items.find(x=>x.id===id);
  const n=prompt("Edit item:",i.name);
  if(n){ i.name=n; save(); render(); }
}
render();

/* =========================
   SCANNER (BLOCKS INVALID)
========================= */
let qr,pending=null,locked=false;
const modal=document.getElementById("modalBg");
const msg=document.getElementById("scanMsg");

function parseQR(t){
  try{
    const u=new URL(t);
    if(u.searchParams.get("item"))
      return {type:"item",name:u.searchParams.get("item"),cat:u.searchParams.get("cat")};
    if(u.searchParams.get("dish"))
      return {type:"dish",name:u.searchParams.get("dish")};
    return {type:"blocked"};
  }catch{ return {type:"blocked"}; }
}

document.getElementById("btnScan").onclick=async()=>{
  modal.style.display="flex"; locked=false; pending=null;
  qr=new Html5Qrcode("reader");
  await qr.start({ facingMode:"environment" },{},txt=>{
    if(locked) return;
    const p=parseQR(txt);
    if(p.type==="blocked"){
      msg.textContent="Blocked QR (must contain item= or dish=)";
      msg.className="scanMsg warn";
      return;
    }
    locked=true; pending=p;
    msg.textContent="Detected → CAPTURE";
    msg.className="scanMsg ok";
    document.getElementById("btnCapture").disabled=false;
  });
};

document.getElementById("btnCapture").onclick=()=>{
  if(!pending) return;
  if(pending.type==="item"){
    const misc=getOrCreateMisc();
    const c=pending.cat ?
      (state.categories.find(x=>norm(x.name)===norm(pending.cat))||
       (state.categories.push({id:id(),name:pending.cat,sort:state.categories.length}),
        state.categories[state.categories.length-1])) : misc;
    addItem(pending.name,c.id);
  }
  if(pending.type==="dish"){
    if(!state.dishCatalog.find(d=>norm(d)===norm(pending.name)))
      state.dishCatalog.push(pending.name);
  }
  document.getElementById("btnCapture").disabled=true;
  locked=false; pending=null;
};

document.getElementById("btnClose").onclick=async()=>{
  modal.style.display="none";
  if(qr){ await qr.stop(); qr=null; }
};

/* =========================
   XLSX IMPORT
========================= */
document.getElementById("fileXlsx").onchange=async e=>{
  if(typeof XLSX==="undefined") return alert("xlsx.full.min.js missing");
  const wb=XLSX.read(await e.target.files[0].arrayBuffer(),{type:"array"});
  const ws=wb.Sheets[wb.SheetNames[0]];
  const rows=XLSX.utils.sheet_to_json(ws,{header:1});
  state.categories=[];
  rows.slice(1).forEach((r,i)=>{
    if(r[0]) state.categories.push({id:id(),name:r[0],sort:i});
  });
  getOrCreateMisc(); save(); render();
};
</script>

</body>
</html>
